# 薯片微内核 - 项目说明

**版本**: 1.0.0  
**更新日期**: 2026-01-31  
**状态**: 全新设计

---

## 1. 项目背景

### 1.1 为什么需要微内核？

薯片生态采用极致的模块化架构，需要一个核心枢纽来协调所有模块的通信。微内核的设计目标是：

1. **实现中心路由原则**：所有模块通信必须经过内核，禁止直接通信
2. **确保完全解耦**：模块间互不依赖，可以独立开发、测试、发布
3. **提供统一标准**：统一的通信协议、接口定义、错误处理
4. **支持灵活部署**：完全独立模式或共享内核模式

### 1.2 与传统架构的区别

**传统架构**：
```
模块A ←→ 模块B
  ↓        ↓
模块C ←→ 模块D
```
- 模块间直接依赖
- 难以替换和升级
- 耦合度高

**微内核架构**：
```
模块A ↘
模块B → 内核 → 模块C
模块D ↗
```
- 所有通信通过内核
- 完全解耦
- 易于替换和扩展

## 2. 设计决策

### 2.1 为什么是"微"内核？

**极简原则**：
- ✅ 只包含路由和管理功能
- ❌ 不包含任何具体功能实现
- ✅ 所有功能通过模块扩展
- ❌ 不包含业务逻辑

**优势**：
- 内核体积小（< 20MB）
- 启动速度快（< 500ms）
- 内存占用少（< 30MB）
- 易于维护和升级

### 2.2 为什么选择 Rust？

**性能要求**：
- 路由延迟必须 < 10ms
- 支持 ≥1000 并发请求
- 内存安全，无GC

**Rust 的优势**：
- ✅ 高性能，接近 C/C++
- ✅ 内存安全，编译时检查
- ✅ 现代并发模型（async/await）
- ✅ 跨平台支持良好
- ✅ 生态丰富

### 2.3 为什么强制中心路由？

**设计原则**：
- 所有模块间通信必须通过内核
- 禁止模块直接通信

**优势**：
1. **完全解耦**：模块互不依赖，可以独立开发
2. **统一标准**：统一的通信协议和接口
3. **可监控性**：所有通信都被记录，便于调试
4. **可替换性**：模块可以随时替换，不影响其他模块
5. **安全性**：统一的权限检查和安全控制

**代价**：
- 路由有一定性能开销（但通过优化可以控制在 10ms 以内）

### 2.4 为什么分离基础层？

**1.0.0 版本的关键决策**：将文件识别、资源管理等功能从内核中分离到公共基础层（Chips-Foundation）。

**原因**：
1. **职责更清晰**：
   - 内核只负责路由和管理
   - 基础层提供基础能力
   - 功能插件实现业务逻辑

2. **更好的模块化**：
   - 基础层的模块可以独立升级
   - 不同软件可以选择需要的基础层模块
   - 减小内核体积

3. **更灵活的部署**：
   - 完全独立模式：打包内核+基础层+功能模块
   - 共享内核模式：共享内核和基础层，每个软件只需打包功能模块

**架构对比**：

旧设计（假设的单体设计）：
```
内核（包含所有功能）~150MB
  ↓
功能插件
```

新设计（1.0.0）：
```
微内核（只有路由和管理）~20MB
  ↓
公共基础层（通用功能）~100MB
  ↓
功能插件（业务逻辑）~10MB
```

## 3. 核心组件

### 3.1 中心路由系统

**职责**：
- 接收路由请求
- 查找目标模块
- 转发请求
- 返回响应
- 记录日志
- 监控性能

**关键特性**：
- 优先级队列
- 并发处理
- 超时控制
- 请求验证

### 3.2 模块管理系统

**职责**：
- 模块扫描和注册
- 依赖解析
- 模块加载和卸载
- 生命周期管理
- 健康检查
- 异常恢复

**关键特性**：
- 按需加载
- 版本兼容性检查
- 循环依赖检测
- 热插拔支持

### 3.3 事件总线

**职责**：
- 事件发布
- 事件订阅
- 事件分发

**关键特性**：
- 并发分发
- 不阻塞发布者
- 订阅者隔离

### 3.4 配置管理

**职责**：
- 配置加载和合并
- 配置读写
- 配置变更通知

**关键特性**：
- 多层级配置
- 配置热更新
- 配置验证

### 3.5 日志系统

**职责**：
- 结构化日志记录
- 日志级别管理
- 日志输出和轮转

**关键特性**：
- 多种日志级别
- 文件和控制台输出
- 日志过滤

## 4. 与公共基础层的关系

### 4.1 职责划分

**微内核（Chips-Core）**：
- ✅ 中心路由
- ✅ 模块管理
- ✅ 事件总线
- ✅ 配置管理
- ✅ 日志系统

**公共基础层（Chips-Foundation）**：
- ✅ 文件识别
- ✅ 资源管理
- ✅ ZIP 处理
- ✅ 运行时管理
- ✅ 窗口管理
- ✅ 媒体组件
- ✅ 文本组件
- ✅ 网络功能

### 4.2 协作方式

Foundation 作为特殊模块注册到 Core：

```
┌─────────────────────────────────────────┐
│         功能插件 (Application)           │
│   需要基础能力时，通过 Core 路由调用     │
└────────────────┬────────────────────────┘
                 ↓ 路由请求
┌─────────────────────────────────────────┐
│          微内核 (Chips-Core)             │
│  - 接收请求                              │
│  - 查找路由表（Foundation 模块）         │
│  - 转发请求                              │
└────────────────┬────────────────────────┘
                 ↓ 路由转发
┌─────────────────────────────────────────┐
│       公共基础层 (Chips-Foundation)      │
│  - 处理请求                              │
│  - 返回响应                              │
└─────────────────────────────────────────┘
```

示例：
```typescript
// 功能插件调用 Foundation
const fileInfo = await core.route({
  action: 'identifyFile',  // 路由到 Foundation 的文件识别模块
  params: { filePath: '/path/to/file' }
});
```

## 5. 部署模式

### 5.1 完全独立模式

```
独立软件包 (~150MB)
├── chips-core (微内核) ~20MB
├── chips-foundation (公共基础层) ~100MB
├── runtime (Electron等) ~20MB
└── modules (功能模块) ~10MB
```

**特点**：
- ✅ 完全自包含
- ✅ 无需安装依赖
- ❌ 体积较大
- ✅ 适合分发给最终用户

### 5.2 共享内核模式

```
系统全局 (~120MB，一次性）:
/usr/local/chips/
├── chips-core
├── chips-foundation
└── runtime

应用1 (~5MB):
TodoApp.app/modules/

应用2 (~5MB):
NoteApp.app/modules/
```

**特点**：
- ✅ 多个应用共享内核和基础层
- ✅ 单个应用体积小
- ✅ 节省空间和内存
- ✅ 适合生态内多个软件

## 6. 性能目标

### 6.1 性能指标

- **路由延迟**：< 10ms (P95)
- **并发支持**：≥1000 并发请求
- **内存占用**：< 30MB（内核本身）
- **启动速度**：< 500ms
- **内核体积**：< 20MB

### 6.2 优化策略

**路由优化**：
- 路由缓存
- 快速路径
- 批量请求

**模块加载优化**：
- 按需加载
- 并行加载

**内存优化**：
- 零拷贝
- 资源池

## 7. 开发路线

### 7.1 1.0.0 版本（当前）

**核心功能**：
- ✅ 中心路由系统
- ✅ 模块管理系统
- ✅ 事件总线
- ✅ 配置管理
- ✅ 日志系统
- ✅ 与 Foundation 集成

**目标**：
- 实现基础的微内核架构
- 与公共基础层无缝集成
- 支持基本的模块开发

### 7.2 1.x 版本（优化）

**计划功能**：
- 性能优化
- 增强模块热插拔
- 完善监控和调试工具
- 提供更多语言的 SDK

### 7.3 2.0.0 版本（未来）

**可能的功能**：
- 分布式支持（内核可部署在服务器）
- 模块远程加载
- 更强的沙箱隔离
- 微服务架构支持

## 8. 技术债务

### 8.1 已知限制

1. **路由性能**：目前路由延迟约 5-10ms，已满足目标，但仍有优化空间
2. **模块语言支持**：目前主要支持 JavaScript/TypeScript 和 Rust，其他语言支持有限
3. **分布式支持**：1.0.0 版本只支持单机部署

### 8.2 未来改进

1. **路由优化**：进一步减少路由延迟
2. **多语言支持**：增加 Python、Go 等语言的完整支持
3. **分布式架构**：支持内核集群部署

## 9. 开发规范

### 9.1 代码规范

- 遵循生态共用的开发规范
- 使用 Rust 标准代码风格
- 保持代码简洁和可读性

### 9.2 文档规范

- 所有公共 API 必须有文档注释
- 重要决策记录在架构决策记录（ADR）中
- 保持文档与代码同步更新

### 9.3 测试规范

- 核心模块测试覆盖率 ≥90%
- 所有公共 API 必须有单元测试
- 关键路径必须有集成测试

## 10. 贡献指南

欢迎贡献！请遵循以下步骤：

1. Fork 项目
2. 创建功能分支
3. 编写代码和测试
4. 提交 Pull Request
5. 通过代码审查
6. 合并到主分支

详见 [CONTRIBUTING.md](./CONTRIBUTING.md)

---

**文档维护者**：Chips 生态核心团队  
**最后更新**：2026-01-31  
**状态**：✅ 生效
