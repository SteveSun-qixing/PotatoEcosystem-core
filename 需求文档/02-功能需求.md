# 薯片微内核 - 功能需求

**版本**: 1.0.0  
**更新日期**: 2026-01-31  
**状态**: 全新设计

---

## 说明

本文档定义薯片微内核 1.0.0 的功能需求。这是全新设计，不包含任何关于文件识别、资源管理等已迁移到公共基础层的功能。

## 2.1 中心路由系统

### 2.1.1 路由表管理

**FR-001：路由表初始化**
- 内核启动时必须初始化路由表
- 路由表包含所有已注册模块的路由规则
- 支持从配置文件加载路由规则
- 优先级：高

**FR-002：路由规则注册**
- 模块注册时可以声明自己能处理的请求类型
- 支持按请求类型（action）路由
- 支持按资源类型（resourceType）路由
- 支持自定义路由规则（正则表达式）
- 优先级：高

**FR-003：路由规则更新**
- 支持运行时动态更新路由规则
- 安装新模块时自动注册路由规则
- 卸载模块时自动移除路由规则
- 优先级：高

**FR-004：路由规则优先级**
- 支持为路由规则设置优先级
- 当多个模块都能处理同一类型请求时，按优先级选择
- 用户自定义优先级高于默认优先级
- 优先级：中

**FR-005：路由表查询**
- 提供接口查询当前路由表状态
- 可查询某个请求类型会被路由到哪个模块
- 可查询某个模块注册了哪些路由规则
- 优先级：中

### 2.1.2 请求处理

**FR-006：接收请求**
- 接收来自任何模块的路由请求
- 请求必须符合标准格式（JSON/MessagePack）
- 请求必须包含：请求ID、发送者ID、请求类型、参数、时间戳
- 优先级：高

**FR-007：请求验证**
- 验证请求格式是否正确
- 验证发送者是否已注册
- 验证发送者是否有权限发送此类请求
- 验证请求参数是否完整
- 格式错误时返回标准错误响应
- 优先级：高

**FR-008：请求路由**
- 根据路由表查找目标模块
- 找不到目标模块时返回错误
- 将请求转发给目标模块
- 记录路由日志（请求ID、源模块、目标模块、时间戳）
- 优先级：高

**FR-009：请求超时处理**
- 为每个请求设置超时时间（默认30秒）
- 超时后取消请求并返回超时错误
- 记录超时日志
- 优先级：高

**FR-010：请求取消**
- 支持发送者主动取消请求
- 通知目标模块停止处理
- 清理相关资源
- 优先级：中

### 2.1.3 响应处理

**FR-011：接收响应**
- 接收来自目标模块的响应
- 响应必须包含：请求ID、状态码、数据、错误信息（如果有）
- 优先级：高

**FR-012：响应转发**
- 根据请求ID找到原始发送者
- 将响应转发给发送者
- 记录响应日志
- 优先级：高

**FR-013：响应超时**
- 如果目标模块在超时时间内未响应，生成超时响应
- 优先级：高

### 2.1.4 请求队列和并发

**FR-014：请求队列**
- 维护请求队列，按顺序处理
- 支持优先级队列（高优先级请求优先处理）
- 优先级：中

**FR-015：并发处理**
- 支持并发处理多个请求
- 并发数可配置（默认：CPU核心数 × 2）
- 优先级：高

**FR-016：流量控制**
- 限制单个模块的请求频率（防止恶意模块）
- 限制全局请求频率（防止过载）
- 优先级：中

## 2.2 模块管理系统

### 2.2.1 模块注册

**FR-017：模块注册**
- 模块启动时必须向内核注册
- 注册信息包含：模块ID、名称、版本、类型、接口定义、依赖列表、路由规则
- 注册成功后分配唯一的会话ID
- 优先级：高

**FR-018：模块发现**
- 扫描模块目录，发现已安装的模块
- 读取模块的元数据文件（module.yaml）
- 建立模块注册表
- 优先级：高

**FR-019：模块验证**
- 验证模块元数据格式
- 验证模块接口定义
- 验证模块签名（可选，用于安全验证）
- 验证失败时拒绝注册
- 优先级：中

**FR-020：重复注册检测**
- 检测模块是否已注册
- 同一模块ID只能注册一次
- 如果已注册，返回错误或更新注册信息（可配置）
- 优先级：中

### 2.2.2 模块加载

**FR-021：按需加载**
- 启动时不加载所有模块
- 当收到需要某个模块的请求时，才加载该模块
- 优先级：高

**FR-022：依赖解析**
- 加载模块前，检查依赖关系
- 递归加载所有依赖模块
- 检测循环依赖并报错
- 优先级：高

**FR-023：版本兼容性检查**
- 检查依赖模块的版本是否符合要求
- 不兼容时报错或使用兼容版本（如果有）
- 优先级：高

**FR-024：加载超时**
- 为模块加载设置超时时间（默认10秒）
- 超时后终止加载并报错
- 优先级：中

**FR-025：加载失败处理**
- 记录加载失败的模块
- 标记为不可用
- 返回详细的错误信息
- 优先级：高

### 2.2.3 模块卸载

**FR-026：模块卸载**
- 支持动态卸载模块
- 卸载前检查是否有其他模块依赖
- 有依赖时拒绝卸载或强制卸载（可配置）
- 优先级：中

**FR-027：资源清理**
- 卸载模块时清理相关资源
- 移除路由规则
- 取消事件订阅
- 关闭通信通道
- 优先级：高

**FR-028：模块重启**
- 支持重启模块（卸载后重新加载）
- 保留模块的配置和状态（如果可能）
- 优先级：低

### 2.2.4 模块状态管理

**FR-029：状态跟踪**
- 跟踪每个模块的状态：未加载、加载中、运行中、错误、已卸载
- 提供接口查询模块状态
- 优先级：中

**FR-030：健康检查**
- 定期检查模块是否正常运行
- 向模块发送心跳请求
- 如果模块无响应，标记为异常
- 优先级：中

**FR-031：异常恢复**
- 模块崩溃时自动重启（可配置）
- 重启失败时标记为不可用
- 记录异常日志
- 优先级：中

### 2.2.5 热插拔

**FR-032：热安装**
- 支持在运行时安装新模块
- 安装后自动注册和加载
- 无需重启内核
- 优先级：低

**FR-033：热更新**
- 支持在运行时更新模块
- 卸载旧版本，加载新版本
- 保留模块状态（如果可能）
- 优先级：低

**FR-034：热卸载**
- 支持在运行时卸载模块
- 处理依赖关系
- 通知依赖模块
- 优先级：低

## 2.3 事件总线

### 2.3.1 事件发布订阅

**FR-035：事件发布**
- 模块可以发布事件
- 事件包含：事件类型、发送者、数据、时间戳
- 优先级：中

**FR-036：事件订阅**
- 模块可以订阅感兴趣的事件类型
- 内核维护事件订阅表
- 收到事件时，转发给所有订阅者
- 优先级：中

**FR-037：取消订阅**
- 模块可以取消事件订阅
- 优先级：中

**FR-038：事件并发分发**
- 并发发送给所有订阅者
- 不阻塞事件发布者
- 优先级：中

**FR-039：事件过滤**
- 支持基于条件的事件过滤
- 只向匹配条件的订阅者发送事件
- 优先级：低

## 2.4 配置管理系统

### 2.4.1 配置加载

**FR-040：配置文件加载**
- 从配置文件加载内核配置
- 支持YAML/JSON格式
- 优先级：高

**FR-041：配置层级**
- 支持多层配置：默认配置 < 系统配置 < 用户配置
- 后面的配置覆盖前面的配置
- 优先级：中

**FR-042：配置验证**
- 验证配置文件格式和内容
- 配置错误时使用默认值并报警告
- 优先级：中

**FR-043：配置热更新**
- 支持运行时更新配置
- 部分配置更新后立即生效，无需重启
- 优先级：低

### 2.4.2 配置访问

**FR-044：配置读取**
- 提供接口读取配置值
- 支持默认值
- 支持嵌套路径访问（如：`router.worker_count`）
- 优先级：高

**FR-045：配置写入**
- 提供接口写入配置值
- 自动持久化到配置文件
- 优先级：高

**FR-046：配置监听**
- 支持监听配置变化
- 配置变化时通知订阅者
- 优先级：中

## 2.5 日志系统

### 2.5.1 日志记录

**FR-047：路由日志**
- 记录所有路由请求和响应
- 包含时间戳、源模块、目标模块、请求类型、耗时
- 优先级：高

**FR-048：模块生命周期日志**
- 记录模块的加载、卸载、错误等事件
- 优先级：中

**FR-049：错误日志**
- 记录所有错误和异常
- 包含详细的错误堆栈和上下文
- 优先级：高

**FR-050：性能日志**
- 记录关键操作的性能数据
- 用于性能分析和优化
- 优先级：低

### 2.5.2 日志管理

**FR-051：日志级别**
- 支持多种日志级别：DEBUG、INFO、WARN、ERROR、FATAL
- 可配置日志级别
- 优先级：中

**FR-052：日志输出**
- 支持输出到文件
- 支持输出到控制台
- 支持结构化日志（JSON格式）
- 优先级：中

**FR-053：日志轮转**
- 日志文件大小达到上限时自动轮转
- 保留最近N个日志文件
- 优先级：低

**FR-054：日志过滤**
- 支持按模块过滤日志
- 支持按级别过滤日志
- 优先级：低

## 2.6 与基础层协作

### 2.6.1 Foundation 模块注册

**FR-055：自动注册基础层模块**
- 内核启动时自动注册 Foundation 模块
- 从配置文件读取 Foundation 模块列表
- 优先级：高

**FR-056：基础层路由配置**
- 配置基础层模块的路由规则
- 支持动态更新基础层路由
- 优先级：高

**FR-057：基础层健康检查**
- 定期检查基础层模块是否正常
- 异常时尝试重启
- 优先级：中

### 2.6.2 基础层调用优化

**FR-058：快速路由**
- 对 Foundation 模块提供快速路由通道
- 减少路由开销
- 优先级：中

**FR-059：批量请求**
- 支持向 Foundation 批量发送请求
- 提高效率
- 优先级：低

## 2.7 标准规范执行

### 2.7.1 接口验证

**FR-060：接口定义检查**
- 验证模块的接口定义是否符合规范
- 检查接口参数、返回值类型
- 优先级：中

**FR-061：接口版本兼容**
- 检查接口版本兼容性
- 不兼容时报警告或拒绝注册
- 优先级：中

### 2.7.2 通信协议执行

**FR-062：消息格式验证**
- 验证所有消息是否符合标准格式
- 格式错误时拒绝处理
- 优先级：高

**FR-063：强制路由**
- 强制所有模块间通信通过内核路由
- 检测直接通信并报警告（开发模式）
- 优先级：高

## 2.8 监控和统计

### 2.8.1 性能监控

**FR-064：路由性能监控**
- 监控路由延迟、吞吐量
- 记录慢请求（>100ms）
- 优先级：中

**FR-065：资源监控**
- 监控CPU使用率、内存占用
- 达到阈值时报警
- 优先级：低

**FR-066：统计信息**
- 统计路由请求数、成功率、失败率
- 统计模块加载次数、错误次数
- 优先级：低

**FR-067：监控接口**
- 提供接口查询监控数据
- 支持导出统计报告
- 优先级：低

## 2.9 安全和权限

### 2.9.1 权限管理

**FR-068：权限定义**
- 定义模块可以拥有的权限类型
- 优先级：中

**FR-069：权限声明**
- 模块注册时必须声明需要的权限
- 优先级：中

**FR-070：权限检查**
- 处理请求前检查发送者是否有权限
- 无权限时拒绝请求
- 优先级：中

**FR-071：权限管理界面**
- 提供接口让用户查看和管理模块权限
- 优先级：低

### 2.9.2 安全控制

**FR-072：请求验证**
- 验证所有请求的合法性
- 防止恶意请求
- 优先级：高

**FR-073：模块隔离**
- 确保模块间完全隔离
- 只能通过路由通信
- 优先级：中

## 2.10 开发者支持

### 2.10.1 SDK和工具

**FR-074：SDK提供**
- 提供 Rust SDK
- 提供 JavaScript/TypeScript SDK
- SDK 封装内核接口，简化模块开发
- 优先级：高

**FR-075：模块脚手架**
- 提供命令行工具快速创建模块项目
- 生成模块模板代码
- 优先级：中

**FR-076：调试工具**
- 提供调试模式，输出详细日志
- 提供路由追踪工具
- 提供性能分析工具
- 优先级：中

**FR-077：文档生成**
- 从接口定义自动生成文档
- 优先级：低

### 2.10.2 测试支持

**FR-078：测试模式**
- 提供测试模式，方便单元测试
- 支持模拟路由请求
- 优先级：中

**FR-079：Mock工具**
- 提供Mock工具，模拟模块响应
- 优先级：低

## 2.11 命令行接口

**FR-080：CLI启动**
- 支持通过命令行启动内核
- 解析命令行参数
- 优先级：中

**FR-081：CLI命令**
- 提供CLI命令管理模块、查询状态等
- 支持脚本化操作
- 优先级：低

## 功能优先级总结

| 优先级 | 数量 | 关键功能领域 |
|--------|------|--------------|
| 高 | 38 | 中心路由、模块管理、配置管理、日志系统、基础层集成 |
| 中 | 27 | 事件总线、权限控制、监控统计、开发工具 |
| 低 | 16 | 高级特性、测试支持、CLI |

**总计**: 81 个功能需求

## 功能依赖关系

```
核心功能（必须首先实现）：
- 中心路由系统（FR-001 到 FR-016）
- 模块注册和加载（FR-017 到 FR-034）
- 配置管理系统（FR-040 到 FR-046）
- 日志系统（FR-047 到 FR-054）

次级功能（依赖核心功能）：
- 事件总线（FR-035 到 FR-039）
- 与基础层协作（FR-055 到 FR-059）
- 标准规范执行（FR-060 到 FR-063）
- 安全和权限（FR-068 到 FR-073）

高级功能（优化和增强）：
- 监控和统计（FR-064 到 FR-067）
- 开发者支持（FR-074 到 FR-079）
- 命令行接口（FR-080 到 FR-081）
```

---

**文档维护者**：Chips 生态核心团队  
**最后更新**：2026-01-31  
**状态**：✅ 生效
