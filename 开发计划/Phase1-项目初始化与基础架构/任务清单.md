# Phase 1: 项目初始化与基础架构

**阶段状态**: 待开始  
**预计任务数**: 12 个  
**关键依赖**: 无

---

## 阶段目标

建立薯片微内核的基础项目结构，包括 Cargo 项目配置、核心数据结构定义、错误处理框架和基础测试框架。

---

## 任务列表

### Task 1.1: 创建 Rust Cargo 项目

**任务描述**: 初始化 Rust Cargo 项目，创建标准的项目目录结构。

**详细步骤**:
1. 在 `Chips-core/` 目录下执行 `cargo init --name chips_core`
2. 创建标准目录结构:
   - `src/` - 源代码目录
   - `src/main.rs` - 可执行文件入口
   - `src/lib.rs` - 库入口
   - `tests/` - 集成测试目录
   - `benches/` - 性能测试目录
   - `examples/` - 示例代码目录

**验收标准**:
- [ ] `cargo build` 成功执行
- [ ] 项目结构符合 Rust 最佳实践

**参考文档**:
- `技术文档/08-代码模块划分.md`

---

### Task 1.2: 配置 Cargo.toml

**任务描述**: 配置完整的 Cargo.toml 文件，包含所有必要的依赖和构建配置。

**详细步骤**:
1. 配置 `[package]` 信息（名称、版本、作者等）
2. 添加核心依赖:
   - `tokio` - 异步运行时
   - `serde` - 序列化
   - `tracing` - 日志
   - `thiserror` - 错误处理
   - 等等...
3. 添加开发依赖:
   - `criterion` - 性能测试
   - `mockall` - Mock 框架
   - `tempfile` - 临时文件
4. 配置 features 标志
5. 配置编译优化参数

**验收标准**:
- [ ] 所有依赖可以正确解析
- [ ] `cargo check` 无错误
- [ ] features 配置正确

**参考文档**:
- `技术文档/08-代码模块划分.md` (Cargo.toml 配置部分)

---

### Task 1.3: 创建模块目录结构

**任务描述**: 按照设计文档创建完整的源代码模块目录结构。

**详细步骤**:
1. 创建 `src/core/` 目录 - 核心层
2. 创建 `src/router/` 目录 - 路由系统
3. 创建 `src/module/` 目录 - 模块管理
4. 创建 `src/utils/` 目录 - 工具模块
5. 创建 `src/api/` 目录 - API 层
6. 在每个目录创建 `mod.rs` 文件

**验收标准**:
- [ ] 目录结构符合设计文档
- [ ] 每个模块有 `mod.rs` 入口文件
- [ ] `cargo check` 无模块解析错误

**参考文档**:
- `技术文档/08-代码模块划分.md`

---

### Task 1.4: 定义核心错误类型

**任务描述**: 使用 `thiserror` 定义项目的核心错误类型。

**详细步骤**:
1. 创建 `src/utils/error.rs` 文件
2. 定义 `CoreError` 枚举类型，包含:
   - `ModuleNotFound` - 模块未找到
   - `RouteNotFound` - 路由未找到
   - `VersionMismatch` - 版本不匹配
   - `CircularDependency` - 循环依赖
   - `InvalidRequest` - 无效请求
   - `Timeout` - 请求超时
   - `PermissionDenied` - 权限拒绝
   - `Io` - IO 错误
   - `Serialization` - 序列化错误
   - 等等...
3. 定义 `Result<T>` 类型别名
4. 实现 `From` trait 进行错误转换

**验收标准**:
- [ ] 所有错误类型符合设计文档
- [ ] 实现了 `std::error::Error` trait
- [ ] 错误消息清晰可读
- [ ] 单元测试通过

**参考文档**:
- `技术文档/07-数据结构设计.md`
- `生态共用/01-薯片协议规范.md` (错误代码部分)

---

### Task 1.5: 定义路由请求/响应数据结构

**任务描述**: 定义路由系统的核心数据结构。

**详细步骤**:
1. 创建 `src/router/request.rs` 文件
2. 定义 `RouteRequest` 结构体:
   - `request_id: String` - 唯一请求 ID
   - `sender: String` - 发送者模块 ID
   - `action: String` - 请求的 action 类型
   - `target: Option<String>` - 目标模块 ID
   - `params: serde_json::Value` - 请求参数
   - `priority: u8` - 优先级
   - `timeout_ms: u64` - 超时时间
   - `timestamp: DateTime<Utc>` - 时间戳
   - `metadata: HashMap<String, String>` - 元数据
3. 定义 `RouteResponse` 结构体:
   - `request_id: String`
   - `status: u16` - 状态码
   - `data: Option<serde_json::Value>`
   - `error: Option<ErrorInfo>`
   - `elapsed_ms: u64`
   - `timestamp: DateTime<Utc>`
4. 定义 `ErrorInfo` 结构体
5. 定义状态码常量
6. 实现构造函数和验证方法

**验收标准**:
- [ ] 数据结构符合设计文档
- [ ] 实现了 `Serialize`/`Deserialize` trait
- [ ] 实现了验证方法
- [ ] 单元测试通过

**参考文档**:
- `技术文档/02-中心路由系统设计.md`
- `技术文档/07-数据结构设计.md`
- `生态共用/01-薯片协议规范.md`

---

### Task 1.6: 定义路由表数据结构

**任务描述**: 定义路由表相关的数据结构。

**详细步骤**:
1. 创建 `src/router/route_table.rs` 文件
2. 定义 `RouteTable` 结构体:
   - `action_routes: HashMap<String, Vec<RouteEntry>>` - action 路由
   - `custom_routes: Vec<CustomRouteEntry>` - 自定义路由
   - `default_route: Option<RouteEntry>` - 默认路由
3. 定义 `RouteEntry` 结构体:
   - `module_id: String`
   - `module_name: String`
   - `priority: i32`
   - `enabled: bool`
   - `created_at: DateTime<Utc>`
   - `updated_at: DateTime<Utc>`
4. 定义 `CustomRouteEntry` 结构体（支持正则匹配）
5. 实现基本的增删改查方法骨架

**验收标准**:
- [ ] 数据结构符合设计文档
- [ ] 支持线程安全（使用 RwLock）
- [ ] 单元测试通过

**参考文档**:
- `技术文档/02-中心路由系统设计.md`
- `技术文档/07-数据结构设计.md`

---

### Task 1.7: 定义模块元数据结构

**任务描述**: 定义模块管理相关的数据结构。

**详细步骤**:
1. 创建 `src/module/metadata.rs` 文件
2. 定义 `ModuleMetadata` 结构体:
   - `id: String`
   - `name: String`
   - `version: semver::Version`
   - `description: Option<String>`
   - `author: Option<String>`
   - `module_type: ModuleType`
   - `entry: EntryPoint`
   - `dependencies: Vec<Dependency>`
   - `interfaces: ModuleInterfaces`
   - `permissions: Vec<String>`
   - `compatibility: Compatibility`
3. 定义 `ModuleType` 枚举
4. 定义 `EntryPoint` 结构体
5. 定义 `Runtime` 枚举
6. 定义 `Dependency` 结构体
7. 定义 `ModuleInterfaces` 结构体
8. 定义 `ModuleState` 枚举
9. 定义 `ModuleInfo` 结构体

**验收标准**:
- [ ] 数据结构符合设计文档
- [ ] 可以从 YAML 文件反序列化
- [ ] 单元测试通过

**参考文档**:
- `技术文档/03-模块管理系统设计.md`
- `技术文档/07-数据结构设计.md`

---

### Task 1.8: 定义事件系统数据结构

**任务描述**: 定义事件总线相关的数据结构。

**详细步骤**:
1. 创建 `src/router/event.rs` 文件
2. 定义 `Event` 结构体:
   - `event_id: String`
   - `event_type: String`
   - `sender: String`
   - `data: serde_json::Value`
   - `timestamp: DateTime<Utc>`
   - `propagate: bool`
3. 定义 `Subscription` 结构体
4. 定义 `EventHandler` trait

**验收标准**:
- [ ] 数据结构符合设计文档
- [ ] 实现了 `Serialize`/`Deserialize` trait
- [ ] 单元测试通过

**参考文档**:
- `生态共用/01-薯片协议规范.md` (事件消息部分)

---

### Task 1.9: 实现 ID 生成工具

**任务描述**: 实现十位 62 进制 ID 生成器。

**详细步骤**:
1. 创建 `src/utils/id.rs` 文件
2. 实现 `generate_id()` 函数:
   - 使用时间戳 + 随机数生成
   - 转换为 62 进制（0-9, a-z, A-Z）
   - 固定 10 位长度
3. 实现 `is_valid_id()` 验证函数
4. 编写单元测试

**验收标准**:
- [ ] 生成的 ID 符合 10 位 62 进制规范
- [ ] ID 唯一性得到保证
- [ ] 单元测试通过

**参考文档**:
- `生态共用/10-十位62进制ID生成规范.md`

---

### Task 1.10: 创建 lib.rs 入口文件

**任务描述**: 配置库的公开 API 和模块导出。

**详细步骤**:
1. 编辑 `src/lib.rs` 文件
2. 声明所有子模块:
   ```rust
   pub mod core;
   pub mod router;
   pub mod module;
   mod utils;
   mod api;
   ```
3. 重导出常用类型:
   ```rust
   pub use core::{ChipsCore, CoreConfig};
   pub use router::{Router, RouteRequest, RouteResponse};
   pub use module::{ModuleManager, ModuleMetadata};
   pub use utils::error::{Error, Result};
   ```
4. 添加 crate 级别文档注释

**验收标准**:
- [ ] `cargo doc` 可以正确生成文档
- [ ] 公开 API 导出正确
- [ ] `cargo check` 无错误

---

### Task 1.11: 创建 main.rs 入口文件

**任务描述**: 创建可执行文件的入口点。

**详细步骤**:
1. 编辑 `src/main.rs` 文件
2. 添加命令行参数解析框架（使用 clap）
3. 实现基本的启动逻辑骨架:
   - 解析命令行参数
   - 加载配置
   - 初始化日志
   - 启动内核
4. 添加优雅关闭逻辑

**验收标准**:
- [ ] `cargo run -- --help` 显示帮助信息
- [ ] 可以指定配置文件路径
- [ ] 程序可以正常启动和退出

---

### Task 1.12: 建立测试框架

**任务描述**: 建立单元测试和集成测试的基础框架。

**详细步骤**:
1. 为每个模块添加 `#[cfg(test)]` 测试模块
2. 创建 `tests/` 目录下的集成测试文件骨架:
   - `tests/router_test.rs`
   - `tests/module_test.rs`
3. 创建 `benches/` 目录下的性能测试骨架:
   - `benches/router_bench.rs`
4. 创建测试辅助函数和 fixtures
5. 确保 `cargo test` 可以运行

**验收标准**:
- [ ] `cargo test` 运行成功
- [ ] 测试框架结构清晰
- [ ] 包含示例测试用例

**参考文档**:
- `技术文档/11-测试手册.md`

---

## 阶段验收标准

- [ ] Cargo 项目可以正常编译 (`cargo build`)
- [ ] 所有核心数据结构已定义
- [ ] 错误处理框架已建立
- [ ] 测试框架已建立
- [ ] `cargo clippy` 无警告
- [ ] `cargo fmt` 格式正确

---

## 注意事项

1. 本阶段主要是结构定义，不需要实现完整逻辑
2. 所有数据结构必须实现 `Debug`、`Clone` trait
3. 需要序列化的结构必须实现 `Serialize`、`Deserialize`
4. 使用 `#[derive]` 宏简化代码
5. 每个任务完成后进行 git commit

---

## 相关文档

- [架构设计](../../技术文档/01-架构设计.md)
- [数据结构设计](../../技术文档/07-数据结构设计.md)
- [代码模块划分](../../技术文档/08-代码模块划分.md)
- [薯片协议规范](../../../生态共用/01-薯片协议规范.md)

---

**创建日期**: 2026-02-01  
**最后更新**: 2026-02-01
