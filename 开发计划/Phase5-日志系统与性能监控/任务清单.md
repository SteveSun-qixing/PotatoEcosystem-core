# Phase 5: 日志系统与性能监控

**阶段状态**: 待开始  
**预计任务数**: 9 个  
**关键依赖**: Phase 2, Phase 3, Phase 4 完成

---

## 阶段目标

实现完整的日志系统和性能监控功能，提供结构化日志记录、日志管理和性能指标收集能力。

---

## 任务列表

### Task 5.1: 实现日志系统核心

**任务描述**: 基于 tracing 实现日志系统核心。

**详细步骤**:
1. 创建 `src/utils/logger.rs` 文件
2. 实现 `Logger` 结构体
3. 配置 tracing-subscriber
4. 支持多种日志级别: TRACE, DEBUG, INFO, WARN, ERROR
5. 实现全局日志初始化函数

**代码示例**:
```rust
use tracing_subscriber::{
    fmt, layer::SubscriberExt, util::SubscriberInitExt, EnvFilter,
};

pub struct Logger {
    config: LogConfig,
}

impl Logger {
    pub fn init(config: LogConfig) -> Result<()> {
        let env_filter = EnvFilter::try_from_default_env()
            .unwrap_or_else(|_| EnvFilter::new(&config.level));
        
        let fmt_layer = fmt::layer()
            .with_target(true)
            .with_thread_ids(true)
            .with_file(true)
            .with_line_number(true);
        
        tracing_subscriber::registry()
            .with(env_filter)
            .with(fmt_layer)
            .init();
        
        Ok(())
    }
}
```

**验收标准**:
- [ ] 日志系统正确初始化
- [ ] 所有日志级别正常工作
- [ ] 全局可用
- [ ] 单元测试通过

---

### Task 5.2: 实现结构化日志

**任务描述**: 实现结构化日志格式。

**详细步骤**:
1. 支持 JSON 格式输出
2. 支持键值对日志字段
3. 实现常用日志宏封装
4. 统一日志字段命名

**代码示例**:
```rust
// 结构化日志示例
info!(
    request_id = %request.request_id,
    sender = %request.sender,
    action = %request.action,
    "Processing request"
);

// JSON 输出格式
// {"timestamp":"2026-02-01T12:00:00Z","level":"INFO","target":"chips_core::router","request_id":"abc123","sender":"editor","action":"file.open","message":"Processing request"}
```

**验收标准**:
- [ ] JSON 格式正确
- [ ] 键值对字段正确
- [ ] 格式一致
- [ ] 单元测试通过

---

### Task 5.3: 实现日志文件输出

**任务描述**: 实现日志输出到文件。

**详细步骤**:
1. 实现文件输出层
2. 支持配置日志文件路径
3. 支持同时输出到文件和控制台
4. 实现异步写入（不阻塞主线程）

**代码示例**:
```rust
use tracing_appender::rolling::{RollingFileAppender, Rotation};

pub fn setup_file_logging(log_dir: &Path) -> Result<()> {
    let file_appender = RollingFileAppender::new(
        Rotation::DAILY,
        log_dir,
        "chips-core.log",
    );
    
    let (non_blocking, _guard) = tracing_appender::non_blocking(file_appender);
    
    // 配置到 tracing-subscriber
}
```

**验收标准**:
- [ ] 文件输出正确
- [ ] 异步写入不阻塞
- [ ] 路径可配置
- [ ] 单元测试通过

---

### Task 5.4: 实现日志轮转

**任务描述**: 实现日志文件的自动轮转。

**详细步骤**:
1. 支持按大小轮转
2. 支持按时间轮转（每天、每小时）
3. 保留最近 N 个日志文件
4. 自动删除旧日志文件

**配置示例**:
```yaml
logging:
  rotation:
    strategy: "daily"  # daily | hourly | size
    max_files: 7
    max_size_mb: 100
```

**验收标准**:
- [ ] 按大小轮转正确
- [ ] 按时间轮转正确
- [ ] 旧文件自动删除
- [ ] 单元测试通过

---

### Task 5.5: 实现日志过滤

**任务描述**: 实现日志过滤功能。

**详细步骤**:
1. 支持按模块过滤
2. 支持按级别过滤
3. 支持运行时动态调整
4. 实现过滤器配置

**代码示例**:
```rust
// 环境变量配置
// RUST_LOG=chips_core=debug,chips_core::router=trace

// 代码配置
let filter = EnvFilter::new("chips_core=info")
    .add_directive("chips_core::router=debug".parse()?);
```

**验收标准**:
- [ ] 模块过滤正确
- [ ] 级别过滤正确
- [ ] 动态调整正常
- [ ] 单元测试通过

---

### Task 5.6: 实现性能指标收集

**任务描述**: 实现性能指标的收集功能。

**详细步骤**:
1. 创建 `src/utils/metrics.rs` 文件
2. 实现 `MetricsCollector` 结构体
3. 收集指标:
   - 路由延迟（平均、P95、P99）
   - 请求吞吐量
   - 成功/失败率
   - 内存使用
   - CPU 使用
4. 使用原子操作确保线程安全

**代码示例**:
```rust
pub struct MetricsCollector {
    // 路由指标
    route_total_count: AtomicU64,
    route_success_count: AtomicU64,
    route_failure_count: AtomicU64,
    route_total_latency_us: AtomicU64,
    
    // 延迟分布
    latency_histogram: Arc<Mutex<Vec<u64>>>,
    
    // 系统指标
    last_memory_usage: AtomicU64,
    last_cpu_usage: AtomicU64,
}

impl MetricsCollector {
    pub fn record_route(&self, success: bool, latency_us: u64) {
        self.route_total_count.fetch_add(1, Ordering::Relaxed);
        self.route_total_latency_us.fetch_add(latency_us, Ordering::Relaxed);
        
        if success {
            self.route_success_count.fetch_add(1, Ordering::Relaxed);
        } else {
            self.route_failure_count.fetch_add(1, Ordering::Relaxed);
        }
        
        // 记录到直方图
        let mut histogram = self.latency_histogram.lock().unwrap();
        histogram.push(latency_us);
    }
    
    pub fn get_p95_latency(&self) -> u64 {
        let mut histogram = self.latency_histogram.lock().unwrap();
        histogram.sort();
        let idx = (histogram.len() as f64 * 0.95) as usize;
        histogram.get(idx).copied().unwrap_or(0)
    }
}
```

**验收标准**:
- [ ] 指标收集准确
- [ ] 线程安全
- [ ] P95/P99 计算正确
- [ ] 单元测试通过

---

### Task 5.7: 实现资源监控

**任务描述**: 实现系统资源监控。

**详细步骤**:
1. 监控内存使用
2. 监控 CPU 使用
3. 设置告警阈值
4. 超过阈值时触发告警

**代码示例**:
```rust
use sysinfo::{System, SystemExt, ProcessExt};

pub struct ResourceMonitor {
    system: System,
    memory_threshold_mb: u64,
}

impl ResourceMonitor {
    pub fn check_resources(&mut self) -> ResourceStatus {
        self.system.refresh_all();
        
        let process = self.system.process(sysinfo::get_current_pid().unwrap()).unwrap();
        let memory_mb = process.memory() / 1024 / 1024;
        
        ResourceStatus {
            memory_mb,
            memory_warning: memory_mb > self.memory_threshold_mb,
        }
    }
}
```

**验收标准**:
- [ ] 内存监控正确
- [ ] CPU 监控正确
- [ ] 告警机制正常
- [ ] 单元测试通过

---

### Task 5.8: 实现监控数据导出

**任务描述**: 实现监控数据的导出功能。

**详细步骤**:
1. 实现 `export()` 方法导出所有指标
2. 支持 JSON 格式导出
3. 提供 API 接口查询指标
4. 支持重置统计

**代码示例**:
```rust
impl MetricsCollector {
    pub fn export(&self) -> MetricsReport {
        MetricsReport {
            timestamp: Utc::now(),
            route_metrics: RouteMetrics {
                total_requests: self.route_total_count.load(Ordering::Relaxed),
                successful_requests: self.route_success_count.load(Ordering::Relaxed),
                failed_requests: self.route_failure_count.load(Ordering::Relaxed),
                avg_latency_us: self.get_avg_latency(),
                p95_latency_us: self.get_p95_latency(),
                p99_latency_us: self.get_p99_latency(),
            },
            system_metrics: SystemMetrics {
                memory_mb: self.last_memory_usage.load(Ordering::Relaxed),
                cpu_percent: self.last_cpu_usage.load(Ordering::Relaxed),
            },
        }
    }
    
    pub fn reset(&self) {
        self.route_total_count.store(0, Ordering::Relaxed);
        // ... 重置其他指标
    }
}
```

**验收标准**:
- [ ] 导出格式正确
- [ ] 数据完整
- [ ] 重置功能正常
- [ ] 单元测试通过

---

### Task 5.9: 日志与监控系统集成测试

**任务描述**: 编写日志和监控系统的集成测试。

**详细步骤**:
1. 创建 `tests/logging_metrics_test.rs`
2. 测试日志系统:
   - 日志级别测试
   - 文件输出测试
   - 日志轮转测试
   - 过滤器测试
3. 测试监控系统:
   - 指标收集测试
   - P95/P99 计算测试
   - 资源监控测试
   - 数据导出测试

**验收标准**:
- [ ] 集成测试覆盖所有场景
- [ ] 所有测试通过

---

## 阶段验收标准

- [ ] 日志系统功能完整
- [ ] 结构化日志正确
- [ ] 日志轮转正常
- [ ] 性能指标收集准确
- [ ] 资源监控正常
- [ ] 单元测试覆盖率 > 85%
- [ ] 集成测试通过

---

## 相关文档

- [开发规范](../../开发规范.md)
- [测试手册](../../技术文档/11-测试手册.md)

---

**创建日期**: 2026-02-01  
**最后更新**: 2026-02-01
