# 薯片微内核 - 接口定义

**版本**: 1.0.0  
**更新日期**: 2026-01-31  
**状态**: 全新设计

---

## 6.1 概述

本文档定义薯片微内核对外提供的所有接口，包括核心 API、模块接口、事件接口等。

**接口版本**：1.0.0  
**协议版本**：1.0.0  
**兼容性**：同一大版本内保持向后兼容

## 6.2 核心 API

### 6.2.1 初始化接口

```rust
pub struct ChipsCore {
    //...
}

impl ChipsCore {
    /// 初始化内核
    ///
    /// # 参数
    /// - `config`: 配置对象
    ///
    /// # 返回
    /// - `Result<ChipsCore>`: 内核实例或错误
    ///
    /// # 示例
    /// ```rust
    /// let core = ChipsCore::initialize(CoreConfig {
    ///     module_path: "./modules".to_string(),
    ///     config_path: "./config".to_string(),
    ///     log_level: LogLevel::Info,
    /// }).await?;
    /// ```
    pub async fn initialize(config: CoreConfig) -> Result<Self>;
    
    /// 启动内核
    pub async fn start(&mut self) -> Result<()>;
    
    /// 停止内核
    pub async fn stop(&mut self) -> Result<()>;
}
```

**JavaScript/TypeScript SDK**：
```typescript
interface CoreConfig {
  modulePath: string;
  configPath?: string;
  logLevel?: 'DEBUG' | 'INFO' | 'WARN' | 'ERROR';
}

class ChipsCore {
  static async initialize(config: CoreConfig): Promise<ChipsCore>;
  async start(): Promise<void>;
  async stop(): Promise<void>;
}
```

### 6.2.2 路由接口

```rust
impl ChipsCore {
    /// 发送路由请求
    ///
    /// # 参数
    /// - `request`: 路由请求对象
    ///
    /// # 返回
    /// - `Result<RouteResponse>`: 响应或错误
    ///
    /// # 示例
    /// ```rust
    /// let response = core.route(RouteRequest {
    ///     sender: "my-module".to_string(),
    ///     action: "generateThumbnail".to_string(),
    ///     target: Some("video-processor".to_string()),
    ///     params: json!({
    ///         "videoPath": "/path/to/video.mp4"
    ///     }),
    ///     ..Default::default()
    /// }).await?;
    /// ```
    pub async fn route(&self, request: RouteRequest) -> Result<RouteResponse>;
    
    /// 批量发送路由请求
    pub async fn route_batch(
        &self, 
        requests: Vec<RouteRequest>
    ) -> Vec<RouteResponse>;
}
```

**JavaScript/TypeScript SDK**：
```typescript
interface RouteRequest {
  action: string;
  target?: string;
  params: Record<string, any>;
  priority?: number;
  timeout?: number;
}

interface RouteResponse {
  requestId: string;
  status: number;
  data?: any;
  error?: ErrorInfo;
  elapsedMs: number;
}

class ChipsCore {
  async route(request: RouteRequest): Promise<RouteResponse>;
  async routeBatch(requests: RouteRequest[]): Promise<RouteResponse[]>;
}
```

### 6.2.3 模块管理接口

```rust
impl ChipsCore {
    /// 注册 Foundation 模块
    pub async fn register_foundation_modules(&mut self) -> Result<()>;
    
    /// 加载模块
    pub async fn load_module(&mut self, module_id: &str) -> Result<()>;
    
    /// 卸载模块
    pub async fn unload_module(&mut self, module_id: &str) -> Result<()>;
    
    /// 查询模块状态
    pub fn get_module_status(&self, module_id: &str) -> Option<ModuleStatus>;
    
    /// 列出所有已注册模块
    pub fn list_modules(&self) -> Vec<ModuleInfo>;
}
```

**JavaScript/TypeScript SDK**：
```typescript
enum ModuleStatus {
  NotLoaded = 'not_loaded',
  Loading = 'loading',
  Running = 'running',
  Error = 'error',
  Unloaded = 'unloaded'
}

interface ModuleInfo {
  id: string;
  name: string;
  version: string;
  status: ModuleStatus;
}

class ChipsCore {
  async registerFoundationModules(): Promise<void>;
  async loadModule(moduleId: string): Promise<void>;
  async unloadModule(moduleId: string): Promise<void>;
  getModuleStatus(moduleId: string): ModuleStatus | null;
  listModules(): ModuleInfo[];
}
```

### 6.2.4 事件接口

```rust
impl ChipsCore {
    /// 发布事件
    pub async fn publish_event(&self, event: Event) -> Result<()>;
    
    /// 订阅事件
    pub async fn subscribe_event(
        &self, 
        event_type: &str, 
        subscriber: &str
    ) -> Result<()>;
    
    /// 取消订阅
    pub async fn unsubscribe_event(
        &self, 
        event_type: &str, 
        subscriber: &str
    ) -> Result<()>;
}
```

**JavaScript/TypeScript SDK**：
```typescript
interface Event {
  type: string;
  data: Record<string, any>;
}

type EventHandler = (event: Event) => void | Promise<void>;

class ChipsCore {
  async publishEvent(event: Event): Promise<void>;
  async subscribe(eventType: string, handler: EventHandler): Promise<void>;
  async unsubscribe(eventType: string, handler: EventHandler): Promise<void>;
}
```

### 6.2.5 配置接口

```rust
impl ChipsCore {
    /// 读取配置
    pub fn get_config<T>(&self, path: &str, default: T) -> T
    where
        T: serde::de::DeserializeOwned;
    
    /// 写入配置
    pub fn set_config<T>(&mut self, path: &str, value: T) -> Result<()>
    where
        T: serde::Serialize;
    
    /// 监听配置变化
    pub fn on_config_change(
        &self, 
        path: &str, 
        callback: Box<dyn Fn(&Value)>
    ) -> Result<()>;
}
```

**JavaScript/TypeScript SDK**：
```typescript
class ChipsCore {
  getConfig<T = any>(path: string, defaultValue?: T): T;
  setConfig(path: string, value: any): Promise<void>;
  onConfigChange(path: string, callback: (value: any) => void): void;
}
```

## 6.3 模块接口

### 6.3.1 模块元数据

```yaml
# module.yaml
id: my-module
name: "My Module"
version: "1.0.0"
type: "plugin"

# 依赖
dependencies:
  - id: another-module
    version: "^1.0.0"

# 路由规则
routes:
  - action: "myAction"
    priority: 10

# 权限声明
permissions:
  - "file.read"
  - "network.request"

# 接口定义
interfaces:
  - action: "myAction"
    params:
      type: object
      properties:
        param1:
          type: string
        param2:
          type: number
    returns:
      type: object
      properties:
        result:
          type: string
```

### 6.3.2 模块生命周期接口

```rust
pub trait ChipsModule {
    /// 模块初始化
    async fn init(&mut self, core: &ChipsCore) -> Result<()>;
    
    /// 模块启动
    async fn start(&mut self) -> Result<()>;
    
    /// 处理路由请求
    async fn handle_request(&self, request: RouteRequest) -> RouteResponse;
    
    /// 处理事件
    async fn handle_event(&self, event: Event) -> Result<()>;
    
    /// 模块停止
    async fn stop(&mut self) -> Result<()>;
    
    /// 健康检查
    fn health_check(&self) -> HealthStatus;
}
```

**JavaScript/TypeScript SDK**：
```typescript
interface ChipsModule {
  init(core: ChipsCore): Promise<void>;
  start(): Promise<void>;
  handleRequest(request: RouteRequest): Promise<RouteResponse>;
  handleEvent(event: Event): Promise<void>;
  stop(): Promise<void>;
  healthCheck(): HealthStatus;
}
```

## 6.4 数据结构定义

### 6.4.1 路由请求

```typescript
interface RouteRequest {
  // 唯一请求ID（UUID v4）
  requestId: string;
  
  // 发送者模块ID
  sender: string;
  
  // 请求的 action 类型
  action: string;
  
  // 目标模块ID（可选）
  target?: string;
  
  // 请求参数
  params: Record<string, any>;
  
  // 优先级（0-10，默认5）
  priority: number;
  
  // 超时时间（毫秒，默认30000）
  timeoutMs: number;
  
  // 时间戳
  timestamp: string;
  
  // 元数据
  metadata: Record<string, string>;
}
```

### 6.4.2 路由响应

```typescript
interface RouteResponse {
  // 关联的请求ID
  requestId: string;
  
  // 状态码
  status: number;
  
  // 响应数据
  data?: any;
  
  // 错误信息
  error?: ErrorInfo;
  
  // 处理耗时（毫秒）
  elapsedMs: number;
  
  // 时间戳
  timestamp: string;
}

interface ErrorInfo {
  // 错误码
  code: string;
  
  // 错误消息
  message: string;
  
  // 详细信息
  details?: string;
  
  // 堆栈跟踪（调试模式）
  stackTrace?: string;
}
```

### 6.4.3 事件对象

```typescript
interface Event {
  // 事件ID
  eventId: string;
  
  // 事件类型
  type: string;
  
  // 发送者模块ID
  sender: string;
  
  // 事件数据
  data: Record<string, any>;
  
  // 时间戳
  timestamp: string;
}
```

### 6.4.4 模块信息

```typescript
interface ModuleInfo {
  // 模块ID
  id: string;
  
  // 模块名称
  name: string;
  
  // 版本号
  version: string;
  
  // 类型
  type: 'plugin' | 'foundation' | 'system';
  
  // 状态
  status: ModuleStatus;
  
  // 依赖列表
  dependencies: ModuleDependency[];
  
  // 路由规则
  routes: RouteRule[];
  
  // 权限
  permissions: string[];
}

interface ModuleDependency {
  id: string;
  version: string;
}

interface RouteRule {
  action: string;
  priority: number;
}
```

## 6.5 错误码定义

### 6.5.1 通用错误码

| 错误码 | 说明 |
|-------|------|
| E_INTERNAL_ERROR | 内部错误 |
| E_INVALID_REQUEST | 请求格式错误 |
| E_INVALID_PARAMS | 参数错误 |
| E_TIMEOUT | 请求超时 |

### 6.5.2 路由错误码

| 错误码 | 说明 |
|-------|------|
| E_ROUTE_NOT_FOUND | 找不到路由 |
| E_MODULE_NOT_FOUND | 目标模块不存在 |
| E_PERMISSION_DENIED | 权限不足 |

### 6.5.3 模块错误码

| 错误码 | 说明 |
|-------|------|
| E_MODULE_LOAD_FAILED | 模块加载失败 |
| E_MODULE_INIT_FAILED | 模块初始化失败 |
| E_DEPENDENCY_NOT_MET | 依赖不满足 |
| E_CIRCULAR_DEPENDENCY | 循环依赖 |

## 6.6 SDK 使用示例

### 6.6.1 JavaScript/TypeScript

```typescript
import { ChipsCore } from '@chips/core';

// 1. 初始化内核
const core = await ChipsCore.initialize({
  modulePath: './modules',
  logLevel: 'INFO'
});

// 2. 注册 Foundation 模块
await core.registerFoundationModules();

// 3. 加载功能模块
await core.loadModule('my-plugin');

// 4. 发送路由请求
const response = await core.route({
  action: 'processData',
  params: {
    data: [1, 2, 3]
  }
});

console.log(response.data);

// 5. 订阅事件
core.subscribe('data.changed', (event) => {
  console.log('Data changed:', event.data);
});

// 6. 发布事件
await core.publishEvent({
  type: 'user.action',
  data: { action: 'click', target: 'button' }
});

// 7. 读取配置
const autoSave = core.getConfig('editor.autoSave', true);

// 8. 停止内核
await core.stop();
```

### 6.6.2 Rust

```rust
use chips_core::{ChipsCore, CoreConfig, RouteRequest};

#[tokio::main]
async fn main() -> Result<()> {
    // 1. 初始化内核
    let mut core = ChipsCore::initialize(CoreConfig {
        module_path: "./modules".to_string(),
        config_path: "./config".to_string(),
        log_level: LogLevel::Info,
    }).await?;
    
    // 2. 注册 Foundation 模块
    core.register_foundation_modules().await?;
    
    // 3. 加载功能模块
    core.load_module("my-plugin").await?;
    
    // 4. 发送路由请求
    let response = core.route(RouteRequest {
        sender: "main".to_string(),
        action: "processData".to_string(),
        params: json!({
            "data": [1, 2, 3]
        }),
        ..Default::default()
    }).await?;
    
    println!("Response: {:?}", response.data);
    
    // 5. 停止内核
    core.stop().await?;
    
    Ok(())
}
```

---

**文档维护者**：Chips 生态核心团队  
**最后更新**：2026-01-31  
**状态**：✅ 生效
