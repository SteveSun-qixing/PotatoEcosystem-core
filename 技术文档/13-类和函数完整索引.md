# 13-类和函数完整索引

## 1. 核心类

### 1.1 ChipsCore

**位置**: `src/core/core.rs`

**作用**: 薯片内核主类,协调所有子系统

**成员变量**
```rust
pub struct ChipsCore {
    router: Arc<Router>,               // 路由系统
    module_manager: Arc<ModuleManager>, // 模块管理器
    resource_manager: Arc<ResourceManager>, // 资源管理器
    file_recognizer: Arc<FileRecognizer>,  // 文件识别器
    config: Arc<RwLock<CoreConfig>>,   // 配置
    logger: Arc<Logger>,               // 日志记录器
    state: Arc<RwLock<CoreState>>,     // 内核状态
}
```

**公共方法**

#### `initialize`
```rust
pub async fn initialize(config: CoreConfig) -> Result<Self>
```
- 作用：初始化内核
- 参数：`config` - 配置对象
- 返回：内核实例或错误

#### `start`
```rust
pub async fn start(&self) -> Result<()>
```
- 作用：启动内核
- 返回：成功或错误

#### `stop`
```rust
pub async fn stop(&self) -> Result<()>
```
- 作用：停止内核
- 返回：成功或错误

#### `router`
```rust
pub fn router(&self) -> &Router
```
- 作用：获取路由系统
- 返回：路由器引用

#### `module_manager`
```rust
pub fn module_manager(&self) -> &ModuleManager
```
- 作用：获取模块管理器
- 返回：模块管理器引用

#### `resource_manager`
```rust
pub fn resource_manager(&self) -> &ResourceManager
```
- 作用：获取资源管理器
- 返回：资源管理器引用

#### `file_recognizer`
```rust
pub fn file_recognizer(&self) -> &FileRecognizer
```
- 作用：获取文件识别器
- 返回：文件识别器引用

---

## 2. 路由系统类

### 2.1 Router

**位置**: `src/router/router.rs`

**作用**: 中心路由系统,处理模块间通信

**成员变量**
```rust
pub struct Router {
    route_table: Arc<RouteTable>,       // 路由表
    request_queue: Arc<RequestQueue>,   // 请求队列
    processor: Arc<RouteProcessor>,     // 请求处理器
    event_bus: Arc<EventBus>,           // 事件总线
    stats: Arc<RouteStats>,             // 统计信息
}
```

**公共方法**

#### `new`
```rust
pub fn new(module_manager: Arc<ModuleManager>, event_bus: Arc<EventBus>) -> Self
```
- 作用：创建路由器
- 参数：模块管理器和事件总线
- 返回：路由器实例

#### `route`
```rust
pub async fn route(&self, request: RouteRequest) -> RouteResponse
```
- 作用：路由请求到目标模块
- 参数：`request` - 路由请求
- 返回：路由响应

#### `route_batch`
```rust
pub async fn route_batch(&self, requests: Vec<RouteRequest>) -> Vec<RouteResponse>
```
- 作用：批量路由请求
- 参数：`requests` - 请求列表
- 返回：响应列表

#### `subscribe`
```rust
pub async fn subscribe(&self, event_type: &str, subscriber: &str) -> Result<()>
```
- 作用：订阅事件
- 参数：`event_type` - 事件类型, `subscriber` - 订阅者ID
- 返回：成功或错误

#### `unsubscribe`
```rust
pub async fn unsubscribe(&self, event_type: &str, subscriber: &str) -> Result<()>
```
- 作用：取消订阅
- 参数：`event_type` - 事件类型, `subscriber` - 订阅者ID
- 返回：成功或错误

#### `broadcast`
```rust
pub async fn broadcast(&self, event: Event)
```
- 作用：广播事件
- 参数：`event` - 事件对象

#### `register_route`
```rust
pub async fn register_route(&self, action: &str, module_id: &str, priority: i32) -> Result<()>
```
- 作用：注册路由规则
- 参数：`action` - 操作名, `module_id` - 模块ID, `priority` - 优先级
- 返回：成功或错误

#### `unregister_route`
```rust
pub async fn unregister_route(&self, action: &str, module_id: &str) -> Result<()>
```
- 作用：移除路由规则
- 参数：`action` - 操作名, `module_id` - 模块ID
- 返回：成功或错误

**私有方法**

#### `find_target_module`
```rust
async fn find_target_module(&self, request: &RouteRequest) -> Result<String>
```
- 作用：查找目标模块
- 参数：`request` - 路由请求
- 返回：模块ID或错误

---

### 2.2 RouteTable

**位置**: `src/router/route_table.rs`

**作用**: 路由表,存储路由规则

**成员变量**
```rust
pub struct RouteTable {
    action_routes: HashMap<String, Vec<RouteEntry>>,  // Action路由
    resource_routes: HashMap<String, Vec<RouteEntry>>, // 资源类型路由
    custom_routes: Vec<CustomRoute>,                   // 自定义路由
    default_route: Option<RouteEntry>,                 // 默认路由
}
```

**公共方法**

#### `new`
```rust
pub fn new() -> Self
```
- 作用：创建路由表
- 返回：路由表实例

#### `find_route`
```rust
pub fn find_route(&self, request: &RouteRequest) -> Option<&RouteEntry>
```
- 作用：查找路由
- 参数：`request` - 路由请求
- 返回：路由条目或None

#### `register`
```rust
pub fn register(&mut self, action: &str, module_id: &str, priority: i32)
```
- 作用：注册路由
- 参数：`action` - 操作名, `module_id` - 模块ID, `priority` - 优先级

#### `unregister`
```rust
pub fn unregister(&mut self, action: &str, module_id: &str)
```
- 作用：移除路由
- 参数：`action` - 操作名, `module_id` - 模块ID

**私有方法**

#### `find_best_entry`
```rust
fn find_best_entry<'a>(&self, entries: &'a [RouteEntry]) -> &'a RouteEntry
```
- 作用：从多个条目中选择最佳的
- 参数：`entries` - 条目列表
- 返回：最佳条目引用

---

### 2.3 EventBus

**位置**: `src/router/event_bus.rs`

**作用**: 事件总线,发布订阅模式

**成员变量**
```rust
pub struct EventBus {
    subscribers: Arc<RwLock<HashMap<String, Vec<String>>>>, // 订阅者
    channels: HashMap<String, mpsc::Sender<Event>>,         // 通道
}
```

**公共方法**

#### `new`
```rust
pub fn new() -> Self
```
- 作用：创建事件总线
- 返回：事件总线实例

#### `subscribe`
```rust
pub async fn subscribe(&self, event_type: &str, subscriber_id: &str) -> Result<()>
```
- 作用：订阅事件
- 参数：`event_type` - 事件类型, `subscriber_id` - 订阅者ID
- 返回：成功或错误

#### `unsubscribe`
```rust
pub async fn unsubscribe(&self, event_type: &str, subscriber_id: &str) -> Result<()>
```
- 作用：取消订阅
- 参数：`event_type` - 事件类型, `subscriber_id` - 订阅者ID
- 返回：成功或错误

#### `publish`
```rust
pub async fn publish(&self, event: Event)
```
- 作用：发布事件
- 参数：`event` - 事件对象

---

## 3. 模块管理类

### 3.1 ModuleManager

**位置**: `src/module/manager.rs`

**作用**: 模块管理器,负责模块生命周期

**成员变量**
```rust
pub struct ModuleManager {
    registry: Arc<ModuleRegistry>,             // 模块注册表
    loader: Arc<ModuleLoader>,                 // 模块加载器
    dependency_resolver: Arc<DependencyResolver>, // 依赖解析器
    lifecycle_manager: Arc<LifecycleManager>,  // 生命周期管理器
}
```

**公共方法**

#### `new`
```rust
pub fn new(module_dirs: Vec<PathBuf>, event_bus: Arc<EventBus>) -> Self
```
- 作用：创建模块管理器
- 参数：`module_dirs` - 模块目录列表, `event_bus` - 事件总线
- 返回：模块管理器实例

#### `scan`
```rust
pub async fn scan(&self) -> Result<Vec<String>>
```
- 作用：扫描模块目录
- 返回：模块ID列表或错误

#### `register`
```rust
pub async fn register(&self, module_path: &Path) -> Result<String>
```
- 作用：注册模块
- 参数：`module_path` - 模块路径
- 返回：模块ID或错误

#### `load`
```rust
pub async fn load(&self, module_id: &str) -> Result<()>
```
- 作用：加载模块
- 参数：`module_id` - 模块ID
- 返回：成功或错误

#### `unload`
```rust
pub async fn unload(&self, module_id: &str) -> Result<()>
```
- 作用：卸载模块
- 参数：`module_id` - 模块ID
- 返回：成功或错误

#### `get_module`
```rust
pub async fn get_module(&self, module_id: &str) -> Option<ModuleInfo>
```
- 作用：获取模块信息
- 参数：`module_id` - 模块ID
- 返回：模块信息或None

#### `list_modules`
```rust
pub async fn list_modules(&self) -> Vec<ModuleInfo>
```
- 作用：列出所有模块
- 返回：模块信息列表

#### `get_state`
```rust
pub async fn get_state(&self, module_id: &str) -> Option<ModuleState>
```
- 作用：获取模块状态
- 参数：`module_id` - 模块ID
- 返回：模块状态或None

---

### 3.2 DependencyResolver

**位置**: `src/module/dependency.rs`

**作用**: 依赖解析器,解析模块依赖关系

**成员变量**
```rust
pub struct DependencyResolver {
    registry: Arc<ModuleRegistry>, // 模块注册表
}
```

**公共方法**

#### `new`
```rust
pub fn new(registry: Arc<ModuleRegistry>) -> Self
```
- 作用：创建依赖解析器
- 参数：`registry` - 模块注册表
- 返回：依赖解析器实例

#### `resolve`
```rust
pub async fn resolve(&self, module_id: &str) -> Result<Vec<String>>
```
- 作用：解析依赖关系
- 参数：`module_id` - 模块ID
- 返回：依赖顺序列表或错误

**私有方法**

#### `resolve_recursive`
```rust
async fn resolve_recursive(
    &self,
    module_id: &str,
    resolved: &mut Vec<String>,
    visited: &mut HashSet<String>,
) -> Result<()>
```
- 作用：递归解析依赖
- 参数：模块ID、已解析列表、已访问集合
- 返回：成功或错误

---

### 3.3 ModuleRegistry

**位置**: `src/module/registry.rs`

**作用**: 模块注册表,存储模块信息

**成员变量**
```rust
pub struct ModuleRegistry {
    modules: Arc<RwLock<HashMap<String, ModuleInfo>>>, // 模块信息
    states: Arc<RwLock<HashMap<String, ModuleState>>>, // 模块状态
    dependency_graph: Arc<RwLock<DependencyGraph>>,    // 依赖图
}
```

**公共方法**

#### `new`
```rust
pub fn new() -> Self
```
- 作用：创建模块注册表
- 返回：模块注册表实例

#### `register`
```rust
pub async fn register(&self, module_info: ModuleInfo) -> Result<()>
```
- 作用：注册模块
- 参数：`module_info` - 模块信息
- 返回：成功或错误

#### `get`
```rust
pub async fn get(&self, module_id: &str) -> Option<ModuleInfo>
```
- 作用：获取模块信息
- 参数：`module_id` - 模块ID
- 返回：模块信息或None

#### `set_state`
```rust
pub async fn set_state(&self, module_id: &str, state: ModuleState) -> Result<()>
```
- 作用：设置模块状态
- 参数：`module_id` - 模块ID, `state` - 状态
- 返回：成功或错误

#### `get_state`
```rust
pub async fn get_state(&self, module_id: &str) -> Option<ModuleState>
```
- 作用：获取模块状态
- 参数：`module_id` - 模块ID
- 返回：模块状态或None

---

## 4. 文件识别类

### 4.1 FileRecognizer

**位置**: `src/file/recognizer.rs`

**作用**: 文件识别器,识别文件类型

**成员变量**
```rust
pub struct FileRecognizer {
    extension_detector: ExtensionDetector,     // 扩展名检测器
    magic_detector: MagicDetector,             // 魔数检测器
    card_parser: CardParser,                   // 卡片解析器
    cache: Arc<RwLock<LruCache<PathBuf, FileType>>>, // 缓存
}
```

**公共方法**

#### `new`
```rust
pub fn new(router: Arc<Router>, resource_manager: Arc<ResourceManager>) -> Self
```
- 作用：创建文件识别器
- 参数：路由器和资源管理器
- 返回：文件识别器实例

#### `recognize`
```rust
pub async fn recognize(&self, file_path: &Path) -> Result<FileType>
```
- 作用：识别文件类型
- 参数：`file_path` - 文件路径
- 返回：文件类型或错误

#### `recognize_by_extension`
```rust
pub fn recognize_by_extension(&self, file_path: &Path) -> Option<FileType>
```
- 作用：通过扩展名识别
- 参数：`file_path` - 文件路径
- 返回：文件类型或None

#### `recognize_by_magic`
```rust
pub async fn recognize_by_magic(&self, file_path: &Path) -> Result<Option<FileType>>
```
- 作用：通过魔数识别
- 参数：`file_path` - 文件路径
- 返回：文件类型或错误

#### `parse_card`
```rust
pub async fn parse_card(&self, file_path: &Path) -> Result<CardFile>
```
- 作用：解析卡片文件
- 参数：`file_path` - 文件路径
- 返回：卡片文件对象或错误

---

### 4.2 ExtensionDetector

**位置**: `src/file/detector/extension.rs`

**作用**: 扩展名检测器

**成员变量**
```rust
pub struct ExtensionDetector {
    extension_map: HashMap<String, FileType>, // 扩展名映射
}
```

**公共方法**

#### `new`
```rust
pub fn new() -> Self
```
- 作用：创建扩展名检测器
- 返回：检测器实例

#### `detect`
```rust
pub fn detect(&self, file_path: &Path) -> Option<FileType>
```
- 作用：检测文件类型
- 参数：`file_path` - 文件路径
- 返回：文件类型或None

---

### 4.3 MagicDetector

**位置**: `src/file/detector/magic.rs`

**作用**: 魔数检测器

**公共方法**

#### `new`
```rust
pub fn new() -> Self
```
- 作用：创建魔数检测器
- 返回：检测器实例

#### `detect`
```rust
pub async fn detect(&self, file_path: &Path) -> Result<Option<FileType>>
```
- 作用：检测文件类型
- 参数：`file_path` - 文件路径
- 返回：文件类型或错误

---

## 5. 资源管理类

### 5.1 ResourceManager

**位置**: `src/resource/manager.rs`

**作用**: 资源管理器,统一资源访问

**成员变量**
```rust
pub struct ResourceManager {
    providers: HashMap<String, Box<dyn ResourceProvider>>, // 提供者
    path_resolver: PathResolver,                            // 路径解析器
    cache_manager: Arc<CacheManager>,                       // 缓存管理器
    auth_manager: Arc<AuthManager>,                         // 认证管理器
}
```

**公共方法**

#### `new`
```rust
pub fn new() -> Self
```
- 作用：创建资源管理器
- 返回：资源管理器实例

#### `read`
```rust
pub async fn read(&self, resource_path: &str) -> Result<Vec<u8>>
```
- 作用：读取资源
- 参数：`resource_path` - 资源路径
- 返回：数据或错误

#### `read_to_string`
```rust
pub async fn read_to_string(&self, resource_path: &str) -> Result<String>
```
- 作用：读取文本资源
- 参数：`resource_path` - 资源路径
- 返回：字符串或错误

#### `write`
```rust
pub async fn write(&self, resource_path: &str, data: &[u8]) -> Result<()>
```
- 作用：写入资源
- 参数：`resource_path` - 资源路径, `data` - 数据
- 返回：成功或错误

#### `exists`
```rust
pub async fn exists(&self, resource_path: &str) -> Result<bool>
```
- 作用：检查资源是否存在
- 参数：`resource_path` - 资源路径
- 返回：是否存在或错误

#### `metadata`
```rust
pub async fn metadata(&self, resource_path: &str) -> Result<ResourceMetadata>
```
- 作用：获取资源元信息
- 参数：`resource_path` - 资源路径
- 返回：元信息或错误

#### `delete`
```rust
pub async fn delete(&self, resource_path: &str) -> Result<()>
```
- 作用：删除资源
- 参数：`resource_path` - 资源路径
- 返回：成功或错误

#### `copy`
```rust
pub async fn copy(&self, from: &str, to: &str) -> Result<()>
```
- 作用：复制资源
- 参数：`from` - 源路径, `to` - 目标路径
- 返回：成功或错误

#### `move_resource`
```rust
pub async fn move_resource(&self, from: &str, to: &str) -> Result<()>
```
- 作用：移动资源
- 参数：`from` - 源路径, `to` - 目标路径
- 返回：成功或错误

**私有方法**

#### `get_provider`
```rust
fn get_provider(&self, scheme: &str) -> Result<&dyn ResourceProvider>
```
- 作用：获取资源提供者
- 参数：`scheme` - 协议名称
- 返回：提供者引用或错误

---

## 6. 工具类

### 6.1 Logger

**位置**: `src/utils/logger.rs`

**作用**: 日志记录器

**公共方法**

#### `initialize`
```rust
pub fn initialize(log_level: &LogLevel) -> Result<Self>
```
- 作用：初始化日志系统
- 参数：`log_level` - 日志级别
- 返回：日志记录器实例或错误

**日志宏**
```rust
debug!(message, args...);  // 调试日志
info!(message, args...);   // 信息日志
warn!(message, args...);   // 警告日志
error!(message, args...);  // 错误日志
```

---

### 6.2 IdGenerator

**位置**: `src/utils/id.rs`

**作用**: ID生成器

**公共方法**

#### `generate_card_id`
```rust
pub fn generate_card_id() -> String
```
- 作用：生成10位62进制卡片ID
- 返回：卡片ID字符串

#### `generate_uuid`
```rust
pub fn generate_uuid() -> String
```
- 作用：生成UUID
- 返回：UUID字符串

**示例**
```rust
let card_id = IdGenerator::generate_card_id();  // "a3Bx9KlMpQ"
let uuid = IdGenerator::generate_uuid();        // "550e8400-e29b-41d4-a716-446655440000"
```

---

## 7. 数据结构类

### 7.1 RouteRequest

**位置**: `src/router/request.rs`

**作用**: 路由请求数据结构

```rust
pub struct RouteRequest {
    pub request_id: String,                  // 请求ID
    pub sender: String,                      // 发送者模块ID
    pub action: String,                      // 操作名称
    pub target: Option<String>,              // 目标模块ID
    pub params: HashMap<String, Value>,      // 参数
    pub priority: i32,                       // 优先级
    pub timeout_ms: u64,                     // 超时时间
    pub resource_type: Option<String>,       // 资源类型
}
```

**公共方法**

#### `new`
```rust
pub fn new(sender: &str, action: &str) -> Self
```
- 作用：创建路由请求
- 参数：`sender` - 发送者, `action` - 操作名
- 返回：路由请求实例

#### `validate`
```rust
pub fn validate(&self) -> Result<()>
```
- 作用：验证请求有效性
- 返回：成功或错误

---

### 7.2 RouteResponse

**位置**: `src/router/request.rs`

**作用**: 路由响应数据结构

```rust
pub struct RouteResponse {
    pub request_id: String,        // 请求ID
    pub status: i32,               // 状态码
    pub data: Option<Value>,       // 响应数据
    pub error: Option<ErrorInfo>,  // 错误信息
    pub elapsed_ms: u64,           // 耗时
}
```

**公共方法**

#### `success`
```rust
pub fn success(request_id: &str, data: Value, elapsed_ms: u64) -> Self
```
- 作用：创建成功响应
- 参数：请求ID、数据、耗时
- 返回：响应实例

#### `error`
```rust
pub fn error(request_id: &str, status: i32, error: ErrorInfo, elapsed_ms: u64) -> Self
```
- 作用：创建错误响应
- 参数：请求ID、状态码、错误信息、耗时
- 返回：响应实例

---

### 7.3 ModuleInfo

**位置**: `src/module/metadata.rs`

**作用**: 模块信息数据结构

```rust
pub struct ModuleInfo {
    pub id: String,                          // 模块ID
    pub name: String,                        // 模块名称
    pub version: String,                     // 版本
    pub description: Option<String>,         // 描述
    pub author: Option<String>,              // 作者
    pub dependencies: Vec<Dependency>,       // 依赖列表
    pub state: ModuleState,                  // 状态
}
```

---

## 8. 完整的类层次结构

```
ChipsCore (核心类)
├── Router (路由系统)
│   ├── RouteTable (路由表)
│   ├── RequestQueue (请求队列)
│   ├── RouteProcessor (请求处理器)
│   └── EventBus (事件总线)
│
├── ModuleManager (模块管理器)
│   ├── ModuleRegistry (模块注册表)
│   ├── ModuleLoader (模块加载器)
│   ├── DependencyResolver (依赖解析器)
│   └── LifecycleManager (生命周期管理器)
│
├── FileRecognizer (文件识别器)
│   ├── ExtensionDetector (扩展名检测器)
│   ├── MagicDetector (魔数检测器)
│   └── CardParser (卡片解析器)
│
└── ResourceManager (资源管理器)
    ├── PathResolver (路径解析器)
    ├── CacheManager (缓存管理器)
    ├── AuthManager (认证管理器)
    └── ResourceProvider (资源提供者)
        ├── LocalProvider (本地文件提供者)
        ├── HttpProvider (HTTP提供者)
        └── WebDAVProvider (WebDAV提供者)
```

---

完整的类和函数索引为开发者提供了清晰的代码结构参考,每个类和函数都包含详细的说明和使用示例。
