# Chips生态通用开发规范

**版本**: 1.0.0  
**适用范围**: 所有Chips生态项目  
**最后更新**: 2026-01-30

---

## 1. 总体原则

### 1.1 核心开发原则

所有Chips生态项目必须遵循以下核心原则：

1. **零硬编码** - 代码中不允许任何明文字符串
2. **中心路由** - 所有模块间通信必须通过薯片内核
3. **前后端分离** - 前端只负责UI，后端只负责业务逻辑
4. **插件化优先** - 所有功能尽可能设计为插件
5. **开源优先** - 优先集成成熟开源方案
6. **轻量极简** - 避免复杂度爆炸，保持简单

### 1.2 架构原则

- **模块解耦**: 模块之间通过标准接口通信，不直接依赖
- **按需加载**: 只加载必需的模块和依赖
- **热插拔**: 支持运行时动态加载/卸载插件
- **版本兼容**: 遵循语义化版本规范

---

## 2. 多语言系统规范

### 2.1 零硬编码要求

**禁止**在代码中直接使用任何明文字符串：

```typescript
// ❌ 错误 - 硬编码文本
<button>确定</button>
alert("保存成功");

// ✅ 正确 - 使用多语言编码
<button>{t('i18n.core.000001')}</button>
alert(t('i18n.ui.100050'));
```

### 2.2 开发阶段使用

开发时使用人类可读的key：

```typescript
// 开发阶段
import { t } from '@chips/i18n';

// 使用可读的key
const text = t('common.save');
const message = t('ui.file_count', { count: 10 });
```

### 2.3 打包时替换

打包时构建工具自动替换为系统编码：

```typescript
// 打包后自动替换为
const text = t('i18n.core.000003');
const message = t('i18n.ui.100002', { count: 10 });
```

### 2.4 配置表管理

所有文本信息必须在配置表中定义：

```yaml
# i18n.yaml - 文本配置表
common:
  save: "保存"
  cancel: "取消"
  delete: "删除"

# messages.yaml - 消息配置表
messages:
  error:
    file_not_found: "i18n.core.010001"
  success:
    save_success: "i18n.core.011001"
```

**参考**: `/生态共用/11-多语言系统规范.md`

---

## 3. 代码风格规范

### 3.1 命名规范

**TypeScript/JavaScript**:
```typescript
// 类名：PascalCase
class FileManager {}

// 函数/方法：camelCase
function loadModule() {}

// 常量：UPPER_SNAKE_CASE
const MAX_RETRY_COUNT = 3;

// 变量：camelCase
let currentIndex = 0;

// 接口：PascalCase，以I开头（可选）
interface ICardPlugin {}
```

**Rust**:
```rust
// 类型/结构体：PascalCase
struct ChipsCore {}

// 函数：snake_case
fn load_module() {}

// 常量：UPPER_SNAKE_CASE
const MAX_RETRY_COUNT: u32 = 3;

// 变量：snake_case
let current_index = 0;

// Trait：PascalCase
trait Plugin {}
```

**Python**:
```python
# 类名：PascalCase
class FileManager:
    pass

# 函数：snake_case
def load_module():
    pass

# 常量：UPPER_SNAKE_CASE
MAX_RETRY_COUNT = 3

# 变量：snake_case
current_index = 0
```

### 3.2 文件命名

- **TypeScript/JavaScript**: kebab-case（`file-manager.ts`）
- **Rust**: snake_case（`file_manager.rs`）
- **Python**: snake_case（`file_manager.py`）
- **配置文件**: kebab-case（`plugin-config.yaml`）

### 3.3 目录结构

标准项目结构：

```
项目名称/
├── src/                  # 源代码
│   ├── core/            # 核心模块
│   ├── api/             # API接口
│   ├── utils/           # 工具函数
│   └── types/           # 类型定义
├── tests/               # 测试代码
│   ├── unit/           # 单元测试
│   ├── integration/    # 集成测试
│   └── e2e/            # E2E测试
├── docs/               # 文档
├── config/             # 配置文件
└── scripts/            # 构建脚本
```

---

## 4. 注释规范

### 4.1 文件头注释

每个源文件必须包含文件头注释：

```typescript
/**
 * @file file-manager.ts
 * @description 文件管理器核心模块
 * @author Chips Team
 * @created 2026-01-30
 */
```

### 4.2 函数/方法注释

使用JSDoc/Rustdoc风格：

```typescript
/**
 * 加载指定模块
 * @param moduleId - 模块ID
 * @param options - 加载选项
 * @returns Promise<Module> 加载的模块实例
 * @throws {ModuleNotFoundError} 模块不存在时抛出
 * @example
 * ```ts
 * const module = await loadModule('my-plugin', { lazy: true });
 * ```
 */
async function loadModule(
  moduleId: string,
  options?: LoadOptions
): Promise<Module> {
  // 实现
}
```

### 4.3 TODO注释

```typescript
// TODO: 实现缓存机制 (@username, 2026-01-30)
// FIXME: 修复内存泄漏问题 (@username, 2026-01-30)
// HACK: 临时解决方案，需要重构 (@username, 2026-01-30)
```

---

## 5. 错误处理规范

### 5.1 错误类型定义

使用标准化的错误码和错误类：

```typescript
// 错误码定义
enum ErrorCode {
  MODULE_NOT_FOUND = 'E1001',
  INVALID_PARAMETER = 'E1002',
  NETWORK_ERROR = 'E2001',
}

// 错误类
class ChipsError extends Error {
  constructor(
    public code: ErrorCode,
    public message: string,
    public details?: any
  ) {
    super(message);
    this.name = 'ChipsError';
  }
}
```

### 5.2 错误处理策略

```typescript
// ✅ 正确 - 捕获并处理错误
try {
  const result = await riskyOperation();
} catch (error) {
  if (error instanceof ChipsError) {
    // 记录错误
    logger.error(error.code, error.message, error.details);
    // 显示用户友好的错误信息
    showError(t('i18n.error.' + error.code));
  } else {
    // 未知错误
    logger.error('UNKNOWN_ERROR', error);
    showError(t('i18n.error.unknown'));
  }
}

// ❌ 错误 - 吞掉错误
try {
  await riskyOperation();
} catch (error) {
  // 什么都不做
}
```

---

## 6. 日志规范

### 6.1 日志级别

使用标准日志级别：

- **ERROR**: 错误，需要立即处理
- **WARN**: 警告，可能导致问题
- **INFO**: 信息，重要的业务事件
- **DEBUG**: 调试信息，开发时使用
- **TRACE**: 追踪信息，详细的执行流程

### 6.2 日志格式

```typescript
// 使用结构化日志
logger.info('module_loaded', {
  moduleId: 'my-plugin',
  version: '1.0.0',
  loadTime: 123,
});

// 不要使用拼接字符串
// ❌ logger.info('Module ' + moduleId + ' loaded in ' + loadTime + 'ms');
```

### 6.3 敏感信息

**禁止**在日志中输出敏感信息：

```typescript
// ❌ 错误
logger.info('User login', { password: user.password });

// ✅ 正确
logger.info('User login', { userId: user.id });
```

---

## 7. 版本控制规范

### 7.1 Git提交规范

使用约定式提交（Conventional Commits）：

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型**:
- `feat`: 新功能
- `fix`: 修复bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `test`: 测试相关
- `chore`: 构建/工具相关

**示例**:
```
feat(editor): 添加无限画布缩放功能

- 实现缩放手势识别
- 添加缩放动画
- 优化渲染性能

Closes #123
```

### 7.2 分支管理

- `main`: 主分支，生产环境代码
- `develop`: 开发分支
- `feature/*`: 功能分支
- `fix/*`: 修复分支
- `release/*`: 发布分支

---

## 8. 测试规范

### 8.1 测试覆盖率

- **核心模块**: ≥90%
- **业务模块**: ≥80%
- **UI组件**: ≥70%

### 8.2 测试文件命名

```
src/
  file-manager.ts
tests/
  unit/
    file-manager.test.ts      # 单元测试
  integration/
    file-manager.spec.ts      # 集成测试
```

### 8.3 测试用例编写

```typescript
describe('FileManager', () => {
  describe('loadFile', () => {
    it('should load file successfully', async () => {
      // Arrange
      const manager = new FileManager();
      const filePath = '/test/file.txt';
      
      // Act
      const content = await manager.loadFile(filePath);
      
      // Assert
      expect(content).toBeDefined();
      expect(content.length).toBeGreaterThan(0);
    });
    
    it('should throw error when file not found', async () => {
      const manager = new FileManager();
      
      await expect(
        manager.loadFile('/non-existent.txt')
      ).rejects.toThrow(ChipsError);
    });
  });
});
```

---

## 9. 性能规范

### 9.1 性能目标

- **启动时间**: <3秒（桌面端）
- **API响应**: <100ms（本地）、<500ms（网络）
- **UI渲染**: 60fps
- **内存占用**: <500MB（空闲）

### 9.2 性能优化原则

- **懒加载**: 按需加载模块和资源
- **缓存策略**: 合理使用缓存
- **批量操作**: 批量处理避免频繁I/O
- **防抖节流**: UI操作使用防抖/节流

```typescript
// 防抖
const debouncedSave = debounce(saveFile, 300);

// 节流
const throttledScroll = throttle(handleScroll, 16); // 60fps
```

---

## 10. 安全规范

### 10.1 输入验证

**所有**外部输入必须验证：

```typescript
function processUserInput(input: string) {
  // 验证
  if (!isValidInput(input)) {
    throw new ChipsError(
      ErrorCode.INVALID_PARAMETER,
      t('i18n.error.invalid_input')
    );
  }
  
  // 消毒
  const sanitized = sanitizeInput(input);
  
  // 处理
  return processInput(sanitized);
}
```

### 10.2 XSS防护

```typescript
// ❌ 错误 - 直接插入HTML
element.innerHTML = userInput;

// ✅ 正确 - 转义
element.textContent = userInput;
// 或使用DOMPurify
element.innerHTML = DOMPurify.sanitize(userInput);
```

### 10.3 敏感数据

- **不在代码中硬编码**密钥和密码
- **使用环境变量**存储敏感配置
- **加密存储**用户敏感数据

---

## 11. 文档规范

### 11.1 代码文档

- 所有公开API必须有完整的文档注释
- 复杂算法需要详细说明
- 关键决策需要注释说明原因

### 11.2 Markdown文档

- 使用标准Markdown语法
- 代码块指定语言
- 适当使用图表辅助说明

### 11.3 文档维护

- 代码变更时同步更新文档
- 每个版本更新CHANGELOG
- 重要变更更新README

---

## 12. 依赖管理规范

### 12.1 依赖选择

- **优先使用**成熟稳定的开源库
- **评估**许可证兼容性
- **避免**过时或无维护的库
- **控制**依赖数量，避免依赖地狱

### 12.2 版本锁定

```json
// package.json - 使用精确版本
{
  "dependencies": {
    "react": "18.2.0",  // 不使用 ^18.2.0
    "lodash": "4.17.21"
  }
}
```

### 12.3 依赖审计

定期审计依赖安全性：

```bash
# npm
npm audit

# yarn
yarn audit

# cargo
cargo audit
```

---

## 13. CI/CD规范

### 13.1 持续集成

每次提交触发：
- ✅ 代码检查（lint）
- ✅ 单元测试
- ✅ 构建验证

### 13.2 持续部署

- **开发环境**: 自动部署develop分支
- **测试环境**: 自动部署release分支
- **生产环境**: 手动触发main分支部署

### 13.3 发布流程

1. 更新版本号（遵循语义化版本）
2. 更新CHANGELOG.md
3. 创建发布分支
4. 运行完整测试
5. 创建Git标签
6. 发布到生产环境
7. 合并回main和develop

---

## 14. 代码审查规范

### 14.1 审查清单

- [ ] 代码符合风格规范
- [ ] 无硬编码字符串
- [ ] 错误处理完整
- [ ] 测试覆盖充分
- [ ] 文档完整准确
- [ ] 性能无明显问题
- [ ] 安全无明显漏洞

### 14.2 审查流程

1. 提交者自查
2. 至少1人审查（核心模块需2人）
3. 所有评论必须解决
4. CI通过后方可合并

---

## 15. 开发工具配置

### 15.1 编辑器配置

`.editorconfig`:
```ini
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.{ts,js,tsx,jsx}]
indent_style = space
indent_size = 2

[*.{rs}]
indent_style = space
indent_size = 4

[*.{py}]
indent_style = space
indent_size = 4

[*.{md}]
trim_trailing_whitespace = false
```

### 15.2 代码检查工具

**TypeScript/JavaScript**:
- ESLint: 代码检查
- Prettier: 代码格式化
- TypeScript: 类型检查

**Rust**:
- clippy: 代码检查
- rustfmt: 代码格式化

**Python**:
- pylint/flake8: 代码检查
- black: 代码格式化
- mypy: 类型检查

---

## 16. 遵循标准

所有项目必须遵循以下生态共用标准：

- `/生态共用/01-薯片协议规范.md` - 通信协议
- `/生态共用/02-卡片文件格式规范.md` - 卡片格式
- `/生态共用/03-箱子文件格式规范.md` - 箱子格式
- `/生态共用/04-系统接口标准.md` - 系统接口
- `/生态共用/05-前端接口标准.md` - 前端接口
- `/生态共用/06-后端接口标准.md` - 后端接口
- `/生态共用/07-插件开发规范.md` - 插件开发
- `/生态共用/11-多语言系统规范.md` - 多语言系统

---

## 17. 违规处理

### 17.1 代码审查阻止

- 硬编码字符串 → **拒绝合并**
- 缺少错误处理 → **拒绝合并**
- 测试覆盖不足 → **要求补充**
- 性能问题 → **要求优化**

### 17.2 技术债务管理

- 标记为TODO的代码必须在3个版本内解决
- HACK必须在1个版本内重构
- 技术债务定期审查

---

## 18. 最佳实践

### 18.1 代码质量

- **DRY**: 不要重复自己
- **KISS**: 保持简单直接
- **YAGNI**: 你不会需要它
- **单一职责**: 一个函数只做一件事
- **开闭原则**: 对扩展开放，对修改关闭

### 18.2 团队协作

- 及时沟通技术决策
- 重大变更提前讨论
- 帮助新成员上手
- 分享经验和最佳实践

---

## 19. 资源和参考

- **生态文档**: `/生态共用/`
- **项目文档**: 各项目的`需求文档/`和`技术文档/`
- **快速导航**: `/快速导航.md`
- **多语言规范**: `/生态共用/11-多语言系统规范.md`

---

## 20. 规范更新

本规范由Chips生态核心团队维护。

**更新流程**:
1. 提出修改建议
2. 团队讨论
3. 更新文档
4. 通知所有项目

**版本历史**:
- v1.0.0 (2026-01-30): 初始版本

---

**维护团队**: Chips生态核心团队  
**联系方式**: chips-dev@example.com  
**最后更新**: 2026-01-30
