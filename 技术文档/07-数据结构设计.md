# 07-数据结构设计

## 7.1 核心数据结构总览

```
薯片内核核心数据结构
├── 路由系统
│   ├── RouteTable（路由表）
│   ├── RouteRequest（路由请求）
│   ├── RouteResponse（路由响应）
│   └── RequestQueue（请求队列）
├── 模块管理
│   ├── ModuleRegistry（模块注册表）
│   ├── ModuleMetadata（模块元数据）
│   ├── DependencyGraph（依赖图）
│   └── ModuleInstance（模块实例）
├── 文件识别
│   ├── FileType（文件类型）
│   ├── FileTypeTable（文件类型表）
│   └── CardInfo（卡片信息）
└── 资源管理
    ├── ResolvedResource（解析后的资源）
    ├── CacheEntry（缓存条目）
    └── ResourceMetadata（资源元信息）
```

## 7.2 路由系统数据结构

### 7.2.1 路由表

```rust
/// 路由表
pub struct RouteTable {
    /// action -> 模块列表
    action_routes: HashMap<String, Vec<RouteEntry>>,
    
    /// 资源类型 -> 模块列表
    resource_routes: HashMap<String, Vec<RouteEntry>>,
    
    /// 文件扩展名 -> 模块列表
    extension_routes: HashMap<String, Vec<RouteEntry>>,
    
    /// 自定义路由（正则）
    custom_routes: Vec<CustomRouteEntry>,
    
    /// 默认路由
    default_route: Option<RouteEntry>,
}

/// 路由条目
pub struct RouteEntry {
    pub module_id: String,
    pub module_name: String,
    pub priority: i32,
    pub enabled: bool,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}
```

### 7.2.2 请求队列

```rust
/// 请求队列（优先级队列）
pub struct RequestQueue {
    queue: Arc<Mutex<BinaryHeap<PriorityQueueItem>>>,
    max_size: usize,
    current_size: Arc<AtomicUsize>,
    notify: Arc<Notify>,
}

/// 优先级队列项
struct PriorityQueueItem {
    item: QueueItem,
    priority: u8,
}

impl Ord for PriorityQueueItem {
    fn cmp(&self, other: &Self) -> Ordering {
        self.priority.cmp(&other.priority)
    }
}

/// 队列项
pub struct QueueItem {
    pub request: RouteRequest,
    pub target_module: String,
    pub response_tx: oneshot::Sender<RouteResponse>,
    pub enqueued_at: Instant,
}
```

## 7.3 模块管理数据结构

### 7.3.1 模块注册表

```rust
/// 模块注册表
pub struct ModuleRegistry {
    /// module_id -> ModuleInfo
    modules: Arc<RwLock<HashMap<String, ModuleInfo>>>,
    
    /// module_id -> ModuleState
    states: Arc<RwLock<HashMap<String, ModuleState>>>,
    
    /// 依赖图
    dependency_graph: Arc<RwLock<DependencyGraph>>,
    
    /// 模块目录
    module_dirs: Vec<PathBuf>,
}

/// 模块信息
pub struct ModuleInfo {
    pub metadata: ModuleMetadata,
    pub path: PathBuf,
    pub registered_at: DateTime<Utc>,
    pub last_loaded_at: Option<DateTime<Utc>>,
    pub load_count: u64,
}
```

### 7.3.2 依赖图

```rust
/// 依赖图（有向图）
pub struct DependencyGraph {
    /// 边：module -> [dependencies]
    edges: HashMap<String, Vec<String>>,
    
    /// 反向边：module -> [dependents]
    reverse_edges: HashMap<String, Vec<String>>,
}

// 核心算法：
// - add_dependency: O(1)
// - get_dependencies: O(1)
// - has_cycle: O(V + E) DFS
// - topological_sort: O(V + E) Kahn算法
```

### 7.3.3 模块元数据

```rust
pub struct ModuleMetadata {
    // 基本信息
    pub id: String,
    pub name: String,
    pub version: Version,
    pub description: Option<String>,
    pub author: Option<String>,
    pub license: Option<String>,
    
    // 模块类型
    pub module_type: ModuleType,
    
    // 入口
    pub entry: EntryPoint,
    
    // 依赖
    pub dependencies: Vec<Dependency>,
    
    // 接口
    pub interfaces: ModuleInterfaces,
    
    // 权限
    pub permissions: Vec<String>,
    
    // 资源需求
    pub resources: ResourceRequirements,
    
    // 兼容性
    pub compatibility: Compatibility,
}
```

## 7.4 文件识别数据结构

### 7.4.1 文件类型

```rust
#[derive(Debug, Clone, PartialEq, Eq, Hash)]
pub enum FileType {
    Card,
    Box,
    Video(VideoCodec),
    Audio(AudioCodec),
    Image(ImageFormat),
    Document(DocumentFormat),
    Code(CodeLanguage),
    Archive(ArchiveFormat),
    Unknown,
}

// 支持的编解码器、格式等
pub enum VideoCodec { H264, H265, VP9, AV1, Unknown }
pub enum AudioCodec { MP3, AAC, Opus, FLAC, WAV, Unknown }
pub enum ImageFormat { JPEG, PNG, GIF, WebP, SVG }
pub enum DocumentFormat { PDF, Markdown, PlainText, HTML }
pub enum CodeLanguage { JavaScript, Python, Rust, Go, Java }
```

### 7.4.2 卡片数据结构

```rust
/// 卡片元数据
pub struct CardMetadata {
    pub id: String,                    // 10位62进制ID
    pub name: String,                  // 卡片名称
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
    pub theme: String,
    pub tags: Vec<Vec<String>>,        // 嵌套标签
    pub chips_standards_version: String,
    pub visibility: Option<String>,
    pub license: Option<String>,
    pub file_info: Option<FileInfo>,
}

/// 卡片结构
pub struct CardStructure {
    /// 基础卡片列表（有序）
    pub structure: Vec<BaseCardEntry>,
    
    /// 资源清单
    pub manifest: Option<ResourceManifest>,
}

/// 基础卡片条目
pub struct BaseCardEntry {
    pub id: String,        // 基础卡片ID
    pub card_type: String, // 类型：VideoCard, ImageCard等
}
```

## 7.5 资源管理数据结构

### 7.5.1 解析后的资源

```rust
/// 解析后的资源
pub struct ResolvedResource {
    /// 完整URL
    pub url: String,
    
    /// Scheme (file, http, https, webdav)
    pub scheme: String,
    
    /// 本地路径（如果是本地资源）
    pub path: PathBuf,
    
    /// 是否可缓存
    pub cacheable: bool,
}
```

### 7.5.2 缓存结构

```rust
/// 缓存管理器
pub struct CacheManager {
    cache_dir: PathBuf,
    
    /// URL -> CacheEntry
    index: Arc<RwLock<HashMap<String, CacheEntry>>>,
    
    /// LRU缓存
    lru: Arc<Mutex<LruCache<String, ()>>>,
    
    max_size: u64,
    current_size: Arc<AtomicU64>,
}

/// 缓存条目
pub struct CacheEntry {
    pub path: PathBuf,
    pub size: u64,
    pub cached_at: DateTime<Utc>,
    pub expires_at: Option<DateTime<Utc>>,
    pub etag: Option<String>,
}
```

## 7.6 日志和监控数据结构

### 7.6.1 路由日志

```rust
#[derive(Serialize)]
pub struct RouteLog {
    pub request_id: String,
    pub sender: String,
    pub target: String,
    pub action: String,
    pub status: u16,
    pub elapsed_ms: u64,
    pub success: bool,
    pub error: Option<String>,
    pub timestamp: DateTime<Utc>,
}
```

### 7.6.2 性能统计

```rust
pub struct RouteStats {
    pub total_requests: AtomicU64,
    pub successful_requests: AtomicU64,
    pub failed_requests: AtomicU64,
    pub total_elapsed_ms: AtomicU64,
    pub min_latency_ms: AtomicU64,
    pub max_latency_ms: AtomicU64,
}
```

## 7.7 内存布局和大小估算

### 7.7.1 核心数据结构大小

```
RouteTable:
- HashMap overhead: ~48 bytes × 4 = 192 bytes
- RouteEntry: ~120 bytes
- 假设100个路由规则: 192 + 100 × 120 = ~12 KB

ModuleRegistry:
- HashMap overhead: ~144 bytes
- ModuleInfo: ~500 bytes
- 假设20个模块: 144 + 20 × 500 = ~10 KB

RequestQueue:
- BinaryHeap overhead: ~24 bytes
- QueueItem: ~200 bytes
- 假设队列容量1000: 24 + 1000 × 200 = ~200 KB

总计：核心数据结构约 ~500 KB - 1 MB
```

### 7.7.2 内存优化策略

**使用Arc减少拷贝**：
```rust
// 好的做法：共享所有权
pub struct ModuleMetadata {
    pub description: Option<Arc<String>>,  // 大字符串用Arc
}

// 避免：频繁克隆大对象
```

**使用Cow延迟克隆**：
```rust
use std::borrow::Cow;

pub fn process_path(path: Cow<str>) -> String {
    if path.starts_with("/") {
        // 如果不需要修改，直接使用原始数据
        path.into_owned()
    } else {
        // 需要修改时才克隆
        format!("/{}", path)
    }
}
```

**使用池化技术**：
```rust
// 对象池，复用频繁创建销毁的对象
pub struct RequestPool {
    pool: Mutex<Vec<RouteRequest>>,
}
```

## 7.8 并发安全

### 7.8.1 锁的使用

```rust
// 读写锁：读多写少
pub struct RouteTable {
    data: Arc<RwLock<HashMap<String, Vec<RouteEntry>>>>,
}

// 互斥锁：简单保护
pub struct RequestQueue {
    queue: Arc<Mutex<BinaryHeap<PriorityQueueItem>>>,
}

// 原子类型：简单计数器
pub struct Stats {
    count: AtomicU64,
}
```

### 7.8.2 无锁数据结构

```rust
// 使用crossbeam的无锁队列
use crossbeam::queue::SegQueue;

pub struct LockFreeQueue<T> {
    queue: Arc<SegQueue<T>>,
}
```

## 7.9 序列化格式

### 7.9.1 配置文件（YAML）

```yaml
# 人类可读，支持注释
module:
  id: "video-card"
  version: "1.0.0"
  dependencies:
    - id: "decoder"
      version: "^2.0.0"
```

### 7.9.2 IPC消息（MessagePack）

```rust
// 二进制格式，高效
let request = RouteRequest { ... };
let bytes = rmp_serde::to_vec(&request)?;
```

### 7.9.3 日志（JSON）

```json
{
  "timestamp": "2026-01-30T12:00:00Z",
  "level": "INFO",
  "module": "router",
  "message": "Request processed",
  "request_id": "..."
}
```

## 7.10 数据持久化

### 7.10.1 模块注册表（SQLite）

```sql
CREATE TABLE modules (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    version TEXT NOT NULL,
    path TEXT NOT NULL,
    metadata TEXT NOT NULL,  -- JSON
    registered_at INTEGER NOT NULL,
    last_loaded_at INTEGER
);

CREATE INDEX idx_modules_name ON modules(name);
```

### 7.10.2 缓存索引（sled嵌入式数据库）

```rust
// 使用sled（嵌入式KV数据库）
let db = sled::open("cache_index")?;
db.insert(url.as_bytes(), serde_json::to_vec(&entry)?)?;
```

## 7.11 数据验证

### 7.11.1 使用validator库

```rust
use validator::Validate;

#[derive(Validate)]
pub struct CardMetadata {
    #[validate(length(min = 10, max = 10))]
    pub id: String,
    
    #[validate(length(min = 1, max = 500))]
    pub name: String,
    
    #[validate(url)]
    pub homepage: Option<String>,
}

// 使用
metadata.validate()?;
```

### 7.11.2 自定义验证

```rust
impl CardMetadata {
    pub fn validate_custom(&self) -> Result<()> {
        // 验证ID格式（10位62进制）
        if !self.id.chars().all(|c| c.is_alphanumeric()) {
            return Err(Error::InvalidId);
        }
        
        // 验证版本号
        Version::parse(&self.chips_standards_version)?;
        
        Ok(())
    }
}
```

---

良好的数据结构设计是高性能和可维护性的基础。选择合适的数据结构可以显著提升性能。
