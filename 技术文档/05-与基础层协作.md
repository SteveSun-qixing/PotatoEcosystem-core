# 薯片微内核 - 与基础层协作

**版本**: 1.0.0  
**更新日期**: 2026-01-31  
**状态**: 全新设计

---

## 5.1 概述

薯片微内核与公共基础层（Chips-Foundation）之间的关系是整个生态架构的关键。微内核负责路由，基础层提供基础能力，二者通过标准化的路由机制协作。

**核心原则**：
- 微内核不直接调用基础层的实现
- 所有调用通过路由系统
- 基础层作为特殊模块注册到微内核
- 基础层模块之间的通信也通过微内核路由

## 5.2 架构关系

### 5.2.1 层级关系

```
┌─────────────────────────────────────────┐
│           应用层 / 功能插件              │
│   需要基础能力时，通过 Core 路由调用     │
└────────────────┬────────────────────────┘
                 ↓ 路由请求
┌─────────────────────────────────────────┐
│          微内核 (Chips-Core)             │
│  - 接收请求                              │
│  - 查找路由（Foundation 模块）           │
│  - 转发请求                              │
│  - 返回响应                              │
└────────────────┬────────────────────────┘
                 ↓ 路由转发
┌─────────────────────────────────────────┐
│       公共基础层 (Chips-Foundation)      │
│  - 文件识别模块                          │
│  - 资源管理模块                          │
│  - ZIP 处理模块                          │
│  - 窗口管理模块                          │
│  - 媒体组件模块                          │
│  - ... 其他基础模块                      │
└─────────────────────────────────────────┘
```

### 5.2.2 职责划分

**微内核职责**：
- ✅ 管理路由表
- ✅ 转发请求到 Foundation 模块
- ✅ 管理 Foundation 模块的生命周期
- ✅ 记录 Foundation 调用日志
- ❌ 不实现任何具体功能

**公共基础层职责**：
- ✅ 提供文件识别能力
- ✅ 提供资源管理能力
- ✅ 提供 ZIP 处理能力
- ✅ 提供窗口管理能力
- ✅ 提供媒体处理能力
- ✅ 提供文本处理能力
- ✅ 提供网络能力
- ❌ 不直接被其他模块调用，必须通过路由

## 5.3 Foundation 模块注册

### 5.3.1 模块清单配置

```yaml
# foundation-modules.yaml
foundation:
  # 核心环境层
  - id: chromium-core
    name: "Chromium 内核"
    version: "1.0.0"
    category: "runtime"
    
  - id: electron-framework
    name: "Electron 框架"
    version: "1.0.0"
    category: "runtime"
    
  - id: runtime-manager
    name: "运行时管理器"
    version: "1.0.0"
    category: "runtime"
  
  # 文件处理层
  - id: file-identifier
    name: "文件识别器"
    version: "1.0.0"
    category: "file"
    routes:
      - action: "identifyFile"
      - action: "identifyFileType"
      - action: "validateCardFile"
  
  - id: zip-processor
    name: "ZIP 处理器"
    version: "1.0.0"
    category: "file"
    routes:
      - action: "createZip"
      - action: "extractZip"
      - action: "readZipEntry"
  
  - id: resource-manager
    name: "资源管理器"
    version: "1.0.0"
    category: "file"
    routes:
      - action: "readResource"
      - action: "writeResource"
      - action: "resolveResourcePath"
  
  # 界面组件层
  - id: window-manager
    name: "窗口管理器"
    version: "1.0.0"
    category: "ui"
    routes:
      - action: "createWindow"
      - action: "closeWindow"
      - action: "resizeWindow"
  
  # 媒体处理层
  - id: video-player
    name: "视频播放器"
    version: "1.0.0"
    category: "media"
    routes:
      - action: "playVideo"
      - action: "pauseVideo"
      - action: "seekVideo"
  
  - id: audio-player
    name: "音频播放器"
    version: "1.0.0"
    category: "media"
    routes:
      - action: "playAudio"
      - action: "pauseAudio"
  
  - id: image-viewer
    name: "图片查看器"
    version: "1.0.0"
    category: "media"
    routes:
      - action: "displayImage"
      - action: "zoomImage"
  
  # 文本处理层
  - id: markdown-parser
    name: "Markdown 解析器"
    version: "1.0.0"
    category: "text"
    routes:
      - action: "parseMarkdown"
      - action: "renderMarkdown"
  
  - id: code-highlighter
    name: "代码高亮器"
    version: "1.0.0"
    category: "text"
    routes:
      - action: "highlightCode"
```

### 5.3.2 自动注册流程

```rust
impl ChipsCore {
    /// 注册 Foundation 模块
    pub async fn register_foundation_modules(&mut self) -> Result<()> {
        // 1. 加载 Foundation 模块清单
        let config = self.load_foundation_config()?;
        
        // 2. 遍历所有 Foundation 模块
        for module_config in config.foundation {
            // 3. 注册模块
            let module_id = module_config.id.clone();
            
            // 4. 注册路由规则
            for route_config in module_config.routes {
                self.router.register_action_route(
                    &route_config.action,
                    RouteEntry {
                        module_id: module_id.clone(),
                        module_name: module_config.name.clone(),
                        priority: 100, // Foundation 模块高优先级
                        enabled: true,
                        created_at: Utc::now(),
                        updated_at: Utc::now(),
                    }
                )?;
            }
            
            // 5. 加载模块
            self.module_manager.load_module(&module_id).await?;
            
            info!("Registered Foundation module: {}", module_id);
        }
        
        Ok(())
    }
}
```

## 5.4 调用模式

### 5.4.1 标准调用流程

```
┌─────────────────────────────────────────────────────┐
│ 1. 功能插件需要识别文件类型                          │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ 2. 向微内核发送路由请求                              │
│    action: "identifyFile"                            │
│    params: { filePath: "/path/to/file.mp4" }        │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ 3. 微内核查找路由表                                  │
│    identifyFile -> file-identifier (Foundation)      │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ 4. 微内核转发请求到 file-identifier 模块            │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ 5. file-identifier 模块处理请求                     │
│    - 读取文件头部                                    │
│    - 识别文件类型                                    │
│    - 返回结果                                        │
└───────────────────────┬─────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────┐
│ 6. 微内核接收响应并转发给功能插件                    │
│    { fileType: "video/mp4", isValid: true }         │
└─────────────────────────────────────────────────────┘
```

### 5.4.2 代码示例

**插件调用 Foundation**（JavaScript）：
```javascript
// 在功能插件中
async function processFile(filePath) {
  // 1. 识别文件类型（调用 Foundation 的文件识别器）
  const fileInfo = await chips.route({
    action: 'identifyFile',
    params: { filePath }
  });
  
  console.log('File type:', fileInfo.data.fileType);
  
  if (fileInfo.data.fileType === 'video/mp4') {
    // 2. 如果是视频，调用 Foundation 的视频播放器
    await chips.route({
      action: 'playVideo',
      params: { videoPath: filePath }
    });
  }
}
```

**Foundation 模块实现**（Rust）：
```rust
// file-identifier 模块实现
impl FileIdentifier {
    pub async fn handle_request(&self, request: RouteRequest) -> RouteResponse {
        match request.action.as_str() {
            "identifyFile" => {
                let file_path = request.params["filePath"].as_str().unwrap();
                
                // 实现文件识别逻辑
                let file_type = self.identify(file_path)?;
                
                RouteResponse::success(
                    &request.request_id,
                    json!({
                        "fileType": file_type,
                        "isValid": true
                    }),
                    10
                )
            }
            _ => RouteResponse::error(
                &request.request_id,
                404,
                ErrorInfo::new("UNKNOWN_ACTION", "Unknown action"),
                0
            )
        }
    }
}
```

## 5.5 常见调用场景

### 5.5.1 文件识别

```javascript
// 场景：用户拖入文件，需要识别类型
const result = await chips.route({
  action: 'identifyFile',
  params: {
    filePath: '/path/to/file'
  }
});

console.log(result.data.fileType); // "video/mp4"
```

### 5.5.2 资源读取

```javascript
// 场景：读取卡片中的资源文件
const content = await chips.route({
  action: 'readResource',
  params: {
    resourcePath: 'card://abc123/content/image.jpg'
  }
});

console.log(content.data); // 文件内容
```

### 5.5.3 ZIP 处理

```javascript
// 场景：创建卡片文件（ZIP 格式）
await chips.route({
  action: 'createZip',
  params: {
    outputPath: '/path/to/card.card',
    files: [
      { path: 'metadata.yaml', content: metadataYaml },
      { path: 'content/image.jpg', filePath: '/tmp/image.jpg' }
    ]
  }
});
```

### 5.5.4 窗口管理

```javascript
// 场景：创建新窗口
const window = await chips.route({
  action: 'createWindow',
  params: {
    title: '卡片查看器',
    width: 800,
    height: 600
  }
});

console.log(window.data.windowId);
```

### 5.5.5 媒体播放

```javascript
// 场景：播放视频
await chips.route({
  action: 'playVideo',
  params: {
    videoPath: '/path/to/video.mp4',
    windowId: 'window-123'
  }
});
```

## 5.6 性能优化

### 5.6.1 Foundation 快速路由

```rust
impl Router {
    /// Foundation 模块快速路由
    pub async fn route_to_foundation(
        &self, 
        action: &str, 
        params: Value
    ) -> RouteResponse {
        // 跳过某些检查，直接路由到 Foundation
        let target = self.foundation_routes.get(action)?;
        self.direct_dispatch(target, action, params).await
    }
}
```

### 5.6.2 批量调用优化

```javascript
// 批量调用 Foundation 模块
const results = await chips.routeBatch([
  { action: 'identifyFile', params: { filePath: 'file1.mp4' } },
  { action: 'identifyFile', params: { filePath: 'file2.jpg' } },
  { action: 'identifyFile', params: { filePath: 'file3.pdf' } }
]);

results.forEach(result => {
  console.log(result.data.fileType);
});
```

## 5.7 健康检查

### 5.7.1 定期检查

```rust
impl FoundationHealthChecker {
    /// 检查 Foundation 模块健康状态
    pub async fn check_health(&self) -> Result<HealthReport> {
        let mut report = HealthReport::new();
        
        for module_id in &self.foundation_modules {
            // 发送心跳请求
            let response = self.core.route(RouteRequest::new(
                "health-checker",
                "healthCheck",
                json!({})
            ).with_target(module_id)).await;
            
            if response.status == 200 {
                report.mark_healthy(module_id);
            } else {
                report.mark_unhealthy(module_id);
                // 尝试重启
                self.restart_module(module_id).await?;
            }
        }
        
        Ok(report)
    }
}
```

## 5.8 错误处理

### 5.8.1 Foundation 模块不可用

```javascript
try {
  const result = await chips.route({
    action: 'identifyFile',
    params: { filePath: '/path/to/file' }
  });
} catch (error) {
  if (error.code === 'MODULE_NOT_FOUND') {
    console.error('Foundation 模块未加载');
    // 尝试重新加载
    await chips.loadFoundationModule('file-identifier');
  }
}
```

### 5.8.2 降级处理

```javascript
// 如果 Foundation 模块不可用，使用降级方案
let fileType;
try {
  const result = await chips.route({
    action: 'identifyFile',
    params: { filePath }
  });
  fileType = result.data.fileType;
} catch (error) {
  // 降级：简单的扩展名判断
  fileType = getFileTypeByExtension(filePath);
}
```

## 5.9 配置

### 5.9.1 Foundation 配置

```yaml
# foundation.yaml
foundation:
  # 启用的模块
  enabled_modules:
    - file-identifier
    - resource-manager
    - zip-processor
    - window-manager
    - video-player
    - audio-player
    - image-viewer
    - markdown-parser
    - code-highlighter
  
  # 健康检查
  health_check:
    enabled: true
    interval_seconds: 30
  
  # 快速路由
  fast_route:
    enabled: true
  
  # 批量调用
  batch_call:
    enabled: true
    max_batch_size: 100
```

---

**文档维护者**：Chips 生态核心团队  
**最后更新**：2026-01-31  
**状态**：✅ 生效
