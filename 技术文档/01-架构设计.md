# 薯片微内核 - 架构设计

**版本**: 1.0.0  
**更新日期**: 2026-01-31  
**状态**: 全新设计

---

## 1.1 整体架构

### 1.1.1 架构概览

薯片微内核采用**纯粹的微内核架构**，核心只包含最基本的路由和管理功能，所有其他能力通过模块扩展。

```
┌─────────────────────────────────────────────────────────┐
│                      应用层                              │
│   ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │
│   │  编辑引擎   │  │   查看器    │  │  各类插件     │  │
│   └─────────────┘  └─────────────┘  └───────────────┘  │
└─────────────────────────────────────────────────────────┘
                           ↓ 路由调用
┌─────────────────────────────────────────────────────────┐
│                  公共基础层 (Foundation)                │
│   ┌─────────────┐  ┌─────────────┐  ┌───────────────┐  │
│   │ 文件识别    │  │ 资源管理    │  │ 窗口管理      │  │
│   ├─────────────┤  ├─────────────┤  ├───────────────┤  │
│   │ ZIP处理     │  │ 媒体组件    │  │ 文本组件      │  │
│   └─────────────┘  └─────────────┘  └───────────────┘  │
└─────────────────────────────────────────────────────────┘
                           ↓ 通过内核路由
┌─────────────────────────────────────────────────────────┐
│                 微内核层 (Chips-Core)                    │
│  ┌────────────────────────────────────────────────────┐ │
│  │          中心路由系统 (Router)                     │ │
│  │    - 请求接收    - 路由查找    - 请求转发         │ │
│  │    - 响应管理    - 性能监控    - 日志记录         │ │
│  └────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────┐ │
│  │      模块管理系统 (ModuleManager)                  │ │
│  │    - 模块注册    - 依赖解析    - 生命周期管理     │ │
│  │    - 按需加载    - 健康检查    - 异常恢复         │ │
│  └────────────────────────────────────────────────────┘ │
│  ┌───────────────┐  ┌──────────────┐  ┌─────────────┐  │
│  │  事件总线     │  │  配置管理    │  │  日志系统   │  │
│  │  (EventBus)   │  │  (Config)    │  │  (Logger)   │  │
│  └───────────────┘  └──────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────────┘
                           ↓ 依赖
┌─────────────────────────────────────────────────────────┐
│                  运行依赖层 (最小化)                     │
│   tokio(异步运行时)  serde(序列化)  tracing(日志)      │
│   semver(版本解析)   config-rs(配置)                    │
└─────────────────────────────────────────────────────────┘
```

### 1.1.2 架构分层

**1. 运行依赖层**
- **tokio**：异步运行时
- **serde**：序列化/反序列化
- **tracing**：日志记录
- **semver**：语义化版本解析
- **config-rs**：配置文件解析

**2. 微内核层（本项目）**
- **中心路由系统**：所有模块通信的枢纽
- **模块管理系统**：模块的注册、加载、卸载、依赖管理
- **事件总线**：事件发布订阅机制
- **配置管理**：统一的配置读写
- **日志系统**：统一的日志记录

**3. 公共基础层（Chips-Foundation）**
- 文件识别、资源管理、ZIP处理
- 运行时管理（JS/Python/WASM）
- 窗口管理、界面组件
- 媒体组件、文本组件
- 网络模块

**4. 应用层**
- 编辑引擎、查看器等完整应用
- 各类功能插件（卡片插件、布局插件等）

### 1.1.3 架构特点

**极简原则**：
- 内核只包含路由和管理功能
- 所有具体功能通过模块提供
- 内核体积 < 20MB，内存占用 < 30MB

**强制中心路由**：
- 所有模块间通信必须通过内核
- 禁止模块直接通信
- 通信过程可监控、可审计

**完全解耦**：
- 模块间互不依赖
- 模块可独立开发、测试、发布
- 模块可随时替换

**事件驱动**：
- 基于事件总线的异步通信
- 模块间松耦合
- 支持并发处理

## 1.2 核心系统架构

### 1.2.1 中心路由系统架构

```
┌────────────────────────────────────────────────────────┐
│                     中心路由系统                        │
│                                                         │
│  ┌─────────────┐                                       │
│  │ 请求接收器  │  ← 接收来自各模块的请求               │
│  │ (Receiver)  │                                       │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │ 请求验证器  │  ← 验证格式、权限                     │
│  │ (Validator) │                                       │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │  路由表     │  ← 查找目标模块                       │
│  │(RouteTable) │                                       │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │  请求队列   │  ← 管理待处理请求(优先级队列)         │
│  │  (Queue)    │                                       │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │ 请求分发器  │  ← 转发请求到目标模块(并发)           │
│  │(Dispatcher) │                                       │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │ 响应管理器  │  ← 接收响应并返回给发送者             │
│  │(ResponseMgr)│                                       │
│  └─────────────┘                                       │
│         ↓                                              │
│  ┌─────────────┐  ┌─────────────┐                     │
│  │  日志记录   │  │  性能监控   │                     │
│  │  (Logger)   │  │  (Monitor)  │                     │
│  └─────────────┘  └─────────────┘                     │
└────────────────────────────────────────────────────────┘
```

**关键特性**：
- **优先级队列**：高优先级请求优先处理
- **并发处理**：支持并发转发多个请求
- **超时控制**：自动处理请求超时
- **日志审计**：记录所有通信
- **性能监控**：监控路由延迟和吞吐量

### 1.2.2 模块管理系统架构

```
┌────────────────────────────────────────────────────────┐
│                   模块管理系统                          │
│                                                         │
│  ┌─────────────┐                                       │
│  │ 模块扫描器  │  ← 扫描模块目录,读取module.yaml       │
│  │ (Scanner)   │                                       │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │ 模块注册表  │  ← 存储已安装模块信息                 │
│  │ (Registry)  │                                       │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │ 依赖解析器  │  ← 解析依赖关系,检查版本兼容性        │
│  │(DepResolver)│                                       │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │ 模块加载器  │  ← 加载模块代码,初始化模块            │
│  │  (Loader)   │                                       │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │生命周期管理器│ ← 管理启动/运行/停止,健康检查        │
│  │(LifecycleMgr│                                       │
│  └─────────────┘                                       │
│         ↓                                              │
│  ┌─────────────────────────────────┐                  │
│  │      运行时模块实例               │                  │
│  │  [Module1] [Module2] [Module3]  │                  │
│  └─────────────────────────────────┘                  │
└────────────────────────────────────────────────────────┘
```

**关键特性**：
- **按需加载**：启动时不加载所有模块
- **依赖解析**：自动处理模块依赖关系
- **版本检查**：确保依赖版本兼容
- **健康检查**：定期检查模块状态
- **异常恢复**：模块崩溃时自动重启

### 1.2.3 事件总线架构

```
┌────────────────────────────────────────────────────────┐
│                     事件总线                            │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │            订阅表 (SubscriptionTable)           │   │
│  │                                                 │   │
│  │  event.type -> [subscriber1, subscriber2, ...]  │   │
│  └─────────────────────────────────────────────────┘   │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │ 事件接收器  │  ← 接收事件发布请求                   │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │ 订阅者查找  │  ← 查找所有订阅者                     │
│  └──────┬──────┘                                       │
│         ↓                                              │
│  ┌─────────────┐                                       │
│  │并发分发器   │  ← 并发向所有订阅者发送事件           │
│  └─────────────┘                                       │
│         ↓                                              │
│  ┌───────────────────────────────────────┐            │
│  │   [Subscriber1] [Subscriber2] [...]   │            │
│  └───────────────────────────────────────┘            │
└────────────────────────────────────────────────────────┘
```

**关键特性**：
- **并发分发**：并发向所有订阅者发送事件
- **不阻塞**：不阻塞事件发布者
- **隔离性**：订阅者异常不影响其他订阅者
- **松耦合**：发布者和订阅者互不依赖

## 1.3 数据流架构

### 1.3.1 请求-响应流

```
┌─────────┐
│ 模块A   │  (发起请求)
└────┬────┘
     │ 1. 发送请求
     ↓
┌─────────────────┐
│  中心路由系统    │
│  ┌───────────┐  │
│  │接收&验证  │  │  2. 验证请求格式和权限
│  └─────┬─────┘  │
│        ↓        │
│  ┌───────────┐  │
│  │查找路由   │  │  3. 查找目标模块
│  └─────┬─────┘  │
│        ↓        │
│  ┌───────────┐  │
│  │入队&分发  │  │  4. 入队并转发
│  └─────┬─────┘  │
└────────┼────────┘
         │ 5. 转发请求
         ↓
    ┌─────────┐
    │ 模块B   │  (目标模块)
    └────┬────┘
         │ 6. 处理请求
         ↓
    ┌─────────┐
    │ 返回响应 │
    └────┬────┘
         │ 7. 返回响应
         ↓
┌─────────────────┐
│  中心路由系统    │
│  ┌───────────┐  │
│  │响应管理   │  │  8. 关联原始请求
│  └─────┬─────┘  │
└────────┼────────┘
         │ 9. 转发响应
         ↓
    ┌─────────┐
    │ 模块A   │  (收到响应)
    └─────────┘
```

### 1.3.2 事件流

```
┌─────────┐
│ 模块A   │  (事件发布者)
└────┬────┘
     │ 1. 发布事件
     ↓
┌─────────────────┐
│   事件总线      │
│  ┌───────────┐  │
│  │查找订阅者 │  │  2. 查找所有订阅者
│  └─────┬─────┘  │
│        ↓        │
│  ┌───────────┐  │
│  │并发分发   │  │  3. 并发发送事件
│  └──┬──┬──┬──┘  │
└─────┼──┼──┼─────┘
      │  │  │
      ↓  ↓  ↓
┌─────┐┌─────┐┌─────┐
│模块B││模块C││模块D│  (订阅者)
└─────┘└─────┘└─────┘
  ↓      ↓      ↓
处理   处理   处理
```

### 1.3.3 模块加载流

```
1. 扫描模块目录
   ↓
2. 读取 module.yaml
   ↓
3. 解析依赖关系
   ↓
4. 检查版本兼容性
   ↓
5. 递归加载依赖模块
   ↓
6. 加载模块代码
   ↓
7. 初始化模块
   ↓
8. 注册路由规则
   ↓
9. 模块就绪
```

## 1.4 部署架构

### 1.4.1 完全独立模式

```
独立软件包 (~150MB)
├── chips-core (微内核) ~20MB
├── chips-foundation (公共基础层) ~100MB
│   ├── file-identifier
│   ├── resource-manager
│   ├── window-manager
│   └── ...
├── runtime (Electron等) ~20MB
└── modules (功能模块) ~10MB
    ├── todo-card
    ├── file-manager
    └── ...

特点：
- 完全自包含，无需安装依赖
- 体积较大
- 适合分发给最终用户
```

### 1.4.2 共享内核模式

```
系统全局安装 (~120MB，一次性）:
/usr/local/chips/ (或 C:\Program Files\Chips\)
├── chips-core (共享内核)
├── chips-foundation (共享基础层)
└── runtime (共享运行时)

应用1 (~5MB):
/Applications/TodoApp.app/
└── modules/
    ├── todo-card
    └── module.yaml

应用2 (~5MB):
/Applications/NoteApp.app/
└── modules/
    ├── markdown-card
    ├── richtext-card
    └── module.yaml

启动方式:
chips-core --app=todo-app
chips-core --app=note-app

特点：
- 多个应用共享内核和基础层
- 单个应用体积小
- 节省空间和内存
```

## 1.5 技术选型

### 1.5.1 编程语言

**Rust**（内核核心）：
- 高性能，接近 C/C++
- 内存安全，无GC
- 现代并发模型（async/await）
- 跨平台支持良好
- 生态丰富（Cargo生态）

### 1.5.2 核心依赖

**tokio**（异步运行时）：
- 成熟的异步运行时
- 高性能
- 支持多线程

**serde**（序列化）：
- 高性能序列化/反序列化
- 支持多种格式（JSON、YAML、MessagePack）

**tracing**（日志）：
- 结构化日志
- 异步支持
- 丰富的日志级别

**semver**（版本解析）：
- 语义化版本解析
- 版本范围匹配

**config-rs**（配置）：
- 支持多种配置格式
- 支持配置层级
- 支持环境变量

### 1.5.3 消息格式

**MessagePack**（路由消息）：
- 二进制格式，紧凑
- 性能高
- 跨语言支持

**JSON**（配置和日志）：
- 人类可读
- 易于调试
- 广泛支持

## 1.6 性能优化

### 1.6.1 路由优化

**路由缓存**：
- 缓存常用路由查找结果
- LRU 策略

**快速路径**：
- 对 Foundation 模块提供快速路由
- 跳过某些检查

**批量请求**：
- 支持批量发送请求
- 减少往返次数

### 1.6.2 模块加载优化

**按需加载**：
- 启动时只加载必需模块
- 其他模块按需加载

**并行加载**：
- 并行加载无依赖关系的模块
- 减少加载时间

### 1.6.3 内存优化

**零拷贝**：
- 尽可能使用零拷贝技术
- 减少内存分配

**资源池**：
- 复用资源（如请求对象）
- 减少GC压力

## 1.7 安全架构

### 1.7.1 权限控制

```
模块注册时声明权限
    ↓
内核验证权限声明
    ↓
运行时检查权限
    ↓
允许/拒绝请求
```

### 1.7.2 模块隔离

- 模块间完全隔离
- 只能通过路由通信
- 无法直接访问其他模块的内存

### 1.7.3 安全审计

- 记录所有路由请求
- 记录所有权限检查
- 可追溯的日志

## 1.8 可扩展性设计

### 1.8.1 横向扩展

**多实例**：
- 支持同时运行多个内核实例
- 每个实例独立，互不影响

### 1.8.2 纵向扩展

**并发处理**：
- 支持并发处理多个请求
- 并发数可配置

**按需加载**：
- 不使用的模块不加载
- 节省资源

## 1.9 架构决策记录

### ADR-001：选择 Rust 作为内核语言

**决策**：使用 Rust

**理由**：
- 高性能，接近 C/C++
- 内存安全，无GC
- 现代并发模型
- 跨平台支持良好

### ADR-002：采用纯粹的微内核架构

**决策**：只在内核中保留路由和管理功能

**理由**：
- 职责清晰，易于维护
- 内核体积小，启动快
- 所有功能通过模块扩展，灵活性高

### ADR-003：强制所有通信通过中心路由

**决策**：禁止模块直接通信

**理由**：
- 完全解耦，模块互不依赖
- 统一的通信协议
- 便于监控、日志、调试

### ADR-004：使用 MessagePack 作为路由消息格式

**决策**：使用 MessagePack

**理由**：
- 二进制格式，紧凑
- 性能高
- 跨语言支持好

---

**文档维护者**：Chips 生态核心团队  
**最后更新**：2026-01-31  
**状态**：✅ 生效
