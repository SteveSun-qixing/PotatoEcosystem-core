# 15-文件结构完整索引

## 1. 项目根目录结构

```
chips-core/
├── Cargo.toml                  # 项目配置文件
├── Cargo.lock                  # 依赖锁定文件
├── README.md                   # 项目说明
├── LICENSE                     # 许可证文件
├── .gitignore                  # Git忽略配置
├── .github/                    # GitHub配置
│   └── workflows/              # CI/CD工作流
│       ├── test.yml           # 测试工作流
│       └── release.yml        # 发布工作流
│
├── src/                        # 源代码目录
├── tests/                      # 集成测试目录
├── benches/                    # 性能测试目录
├── examples/                   # 示例代码目录
├── docs/                       # 文档目录
├── target/                     # 编译输出目录（生成）
└── .cargo/                     # Cargo本地配置
```

---

## 2. 源代码结构 (src/)

### 2.1 完整文件树

```
src/
├── main.rs                     # 二进制入口点
├── lib.rs                      # 库入口点
│
├── core/                       # 核心层
│   ├── mod.rs                 # 模块声明
│   ├── core.rs                # Core trait实现
│   └── config.rs              # 配置加载
│
├── router/                     # 路由系统
│   ├── mod.rs                 # 模块声明
│   ├── router.rs              # Router trait实现
│   ├── route_table.rs         # 路由表
│   ├── request.rs             # 请求/响应
│   ├── queue.rs               # 请求队列
│   ├── processor.rs           # 请求处理器
│   └── event_bus.rs           # 事件总线
│
├── module/                     # 模块管理
│   ├── mod.rs                 # 模块声明
│   ├── manager.rs             # ModuleManager
│   ├── registry.rs            # 模块注册表
│   ├── metadata.rs            # 模块元数据
│   ├── loader.rs              # 模块加载器
│   ├── dependency.rs          # 依赖解析
│   ├── lifecycle.rs           # 生命周期管理
│   └── runtime/               # 运行时管理器
│       ├── mod.rs
│       ├── js.rs              # JavaScript运行时
│       ├── python.rs          # Python运行时
│       └── wasm.rs            # WASM运行时
│
├── file/                       # 文件识别
│   ├── mod.rs                 # 模块声明
│   ├── recognizer.rs          # 文件识别器
│   ├── file_type.rs           # 文件类型定义
│   ├── detector/              # 检测器
│   │   ├── mod.rs
│   │   ├── extension.rs       # 扩展名检测
│   │   ├── magic.rs           # 魔数检测
│   │   └── mime.rs            # MIME检测
│   └── card/                  # 卡片解析
│       ├── mod.rs
│       ├── parser.rs          # 卡片解析器
│       ├── metadata.rs        # 卡片元数据
│       └── structure.rs       # 卡片结构
│
├── resource/                   # 资源管理
│   ├── mod.rs                 # 模块声明
│   ├── manager.rs             # ResourceManager
│   ├── provider/              # 资源提供者
│   │   ├── mod.rs
│   │   ├── local.rs           # 本地文件
│   │   ├── http.rs            # HTTP
│   │   └── webdav.rs          # WebDAV
│   ├── resolver.rs            # 路径解析
│   ├── cache.rs               # 缓存管理
│   └── auth.rs                # 认证管理
│
├── utils/                      # 工具模块
│   ├── mod.rs                 # 模块声明
│   ├── logger.rs              # 日志系统
│   ├── error.rs               # 错误类型
│   ├── id.rs                  # ID生成
│   └── crypto.rs              # 加密工具
│
└── api/                        # API层
    ├── mod.rs                 # 模块声明
    ├── sdk.rs                 # SDK接口
    ├── http.rs                # HTTP API
    ├── cli.rs                 # CLI接口
    └── ipc.rs                 # IPC接口
```

### 2.2 文件作用说明

#### **main.rs**
- 二进制程序入口
- 解析命令行参数
- 启动内核

#### **lib.rs**
- 库入口，导出公共API
- 重导出常用类型和函数

#### **core/core.rs**
- `ChipsCore` 主类实现
- 内核初始化和启动逻辑
- 协调各子系统

#### **core/config.rs**
- `CoreConfig` 配置结构
- 配置文件加载和解析
- 多层配置合并

#### **router/router.rs**
- `Router` 实现
- 路由请求处理
- 事件广播

#### **router/route_table.rs**
- `RouteTable` 路由表
- 路由规则存储和查找
- 优先级管理

#### **router/request.rs**
- `RouteRequest` 请求结构
- `RouteResponse` 响应结构
- 请求验证

#### **router/queue.rs**
- `RequestQueue` 请求队列
- 优先级队列实现
- 流量控制

#### **router/processor.rs**
- `RouteProcessor` 请求处理器
- 并发请求处理
- 超时控制

#### **router/event_bus.rs**
- `EventBus` 事件总线
- 发布订阅实现
- 事件分发

#### **module/manager.rs**
- `ModuleManager` 模块管理器
- 模块加载和卸载
- 生命周期管理

#### **module/registry.rs**
- `ModuleRegistry` 模块注册表
- 模块信息存储
- 状态管理

#### **module/metadata.rs**
- `ModuleMetadata` 元数据结构
- `ModuleInfo` 信息结构
- 元数据解析

#### **module/loader.rs**
- `ModuleLoader` 模块加载器
- 动态加载模块代码
- 多运行时支持

#### **module/dependency.rs**
- `DependencyResolver` 依赖解析器
- 依赖关系解析
- 循环依赖检测

#### **module/lifecycle.rs**
- `LifecycleManager` 生命周期管理器
- 模块初始化、启动、停止
- 健康检查

#### **module/runtime/js.rs**
- JavaScript运行时管理
- V8引擎集成
- 模块沙箱

#### **module/runtime/python.rs**
- Python运行时管理
- PyO3集成
- Python模块加载

#### **module/runtime/wasm.rs**
- WASM运行时管理
- Wasmtime集成
- WASM模块执行

#### **file/recognizer.rs**
- `FileRecognizer` 文件识别器
- 综合多种检测方法
- 识别结果缓存

#### **file/file_type.rs**
- `FileType` 枚举定义
- 支持的文件类型
- 类型转换

#### **file/detector/extension.rs**
- `ExtensionDetector` 扩展名检测器
- 扩展名映射表
- 快速识别

#### **file/detector/magic.rs**
- `MagicDetector` 魔数检测器
- 文件头部字节读取
- 魔数匹配

#### **file/detector/mime.rs**
- `MimeDetector` MIME类型检测器
- 基于内容的MIME推断

#### **file/card/parser.rs**
- `CardParser` 卡片解析器
- ZIP文件读取
- 卡片结构解析

#### **file/card/metadata.rs**
- `CardMetadata` 卡片元数据
- 元数据验证

#### **file/card/structure.rs**
- `CardStructure` 卡片结构
- 内容组织

#### **resource/manager.rs**
- `ResourceManager` 资源管理器
- 统一资源访问接口
- 缓存和认证集成

#### **resource/provider/local.rs**
- `LocalFileProvider` 本地文件提供者
- 文件系统操作

#### **resource/provider/http.rs**
- `HttpProvider` HTTP提供者
- HTTP/HTTPS资源下载

#### **resource/provider/webdav.rs**
- `WebDAVProvider` WebDAV提供者
- WebDAV协议实现

#### **resource/resolver.rs**
- `PathResolver` 路径解析器
- 路径标准化
- 协议识别

#### **resource/cache.rs**
- `CacheManager` 缓存管理器
- LRU缓存实现
- 缓存验证和更新

#### **resource/auth.rs**
- `AuthManager` 认证管理器
- 凭证存储
- Token刷新

#### **utils/logger.rs**
- `Logger` 日志记录器
- tracing集成
- 结构化日志

#### **utils/error.rs**
- `Error` 错误类型枚举
- `ErrorInfo` 错误信息结构
- 错误转换实现

#### **utils/id.rs**
- `IdGenerator` ID生成器
- 62进制ID生成
- UUID生成

#### **utils/crypto.rs**
- 加密工具函数
- 密钥管理
- 哈希计算

#### **api/sdk.rs**
- SDK接口定义
- 模块上下文

#### **api/http.rs**
- HTTP API实现
- RESTful接口
- WebSocket支持

#### **api/cli.rs**
- CLI接口实现
- 命令解析
- 交互式命令行

#### **api/ipc.rs**
- IPC接口实现
- 进程间通信
- 消息序列化

---

## 3. 测试目录结构 (tests/)

```
tests/
├── common/                     # 公共测试工具
│   ├── mod.rs
│   ├── fixtures.rs            # 测试数据
│   └── helpers.rs             # 辅助函数
│
├── fixtures/                   # 测试固件
│   ├── cards/                 # 测试卡片文件
│   │   ├── todo.cchips
│   │   ├── markdown.cchips
│   │   └── image.cchips
│   ├── boxes/                 # 测试箱子文件
│   │   └── test.cbox
│   └── modules/               # 测试模块
│       └── test-module/
│           ├── module.yaml
│           └── index.js
│
├── router_test.rs              # 路由系统测试
├── module_test.rs              # 模块管理测试
├── file_test.rs                # 文件识别测试
├── resource_test.rs            # 资源管理测试
└── integration_test.rs         # 集成测试
```

### 3.1 测试文件说明

#### **common/fixtures.rs**
- 创建测试数据
- 测试文件生成
- 清理测试数据

#### **common/helpers.rs**
- 测试辅助函数
- 断言辅助
- Mock对象创建

#### **router_test.rs**
- 路由请求测试
- 路由表测试
- 事件总线测试
- 并发测试

#### **module_test.rs**
- 模块加载测试
- 依赖解析测试
- 生命周期测试
- 版本兼容性测试

#### **file_test.rs**
- 文件类型识别测试
- 卡片解析测试
- 文件验证测试

#### **resource_test.rs**
- 资源读写测试
- 缓存测试
- 多提供者测试

#### **integration_test.rs**
- 端到端测试
- 系统集成测试

---

## 4. 性能测试目录 (benches/)

```
benches/
├── router_bench.rs             # 路由性能测试
├── module_bench.rs             # 模块加载性能测试
├── file_bench.rs               # 文件识别性能测试
└── resource_bench.rs           # 资源访问性能测试
```

### 4.1 性能测试文件说明

#### **router_bench.rs**
- 路由请求延迟
- 吞吐量测试
- 并发性能

#### **module_bench.rs**
- 模块加载时间
- 依赖解析性能

#### **file_bench.rs**
- 文件识别速度
- 卡片解析性能

#### **resource_bench.rs**
- 资源读取速度
- 缓存命中率

---

## 5. 示例代码目录 (examples/)

```
examples/
├── basic_usage.rs              # 基础使用示例
├── custom_module.rs            # 自定义模块示例
├── resource_access.rs          # 资源访问示例
├── event_handling.rs           # 事件处理示例
└── plugin_development.rs       # 插件开发示例
```

### 5.1 示例文件说明

#### **basic_usage.rs**
- 内核初始化
- 基本API使用
- 简单的路由请求

#### **custom_module.rs**
- 自定义模块开发
- 模块注册和加载
- 路由处理

#### **resource_access.rs**
- 本地文件访问
- HTTP资源下载
- WebDAV使用

#### **event_handling.rs**
- 事件订阅
- 事件发布
- 事件处理

#### **plugin_development.rs**
- 插件结构
- 插件接口实现
- 插件打包

---

## 6. 文档目录 (docs/)

```
docs/
├── api/                        # API文档（cargo doc生成）
│   └── chips_core/
│       ├── index.html
│       └── ...
│
├── guides/                     # 开发指南
│   ├── getting-started.md     # 快速开始
│   ├── module-development.md  # 模块开发
│   ├── plugin-development.md  # 插件开发
│   └── best-practices.md      # 最佳实践
│
├── architecture/               # 架构文档
│   ├── overview.md            # 架构概览
│   ├── router.md              # 路由系统
│   ├── module.md              # 模块管理
│   └── resource.md            # 资源管理
│
└── examples/                   # 示例和教程
    ├── hello-world.md         # Hello World
    ├── file-processing.md     # 文件处理
    └── custom-provider.md     # 自定义提供者
```

---

## 7. 配置文件

### 7.1 Cargo.toml

```toml
[package]
name = "chips-core"
version = "1.0.0"
edition = "2021"
authors = ["Chips Team"]
license = "MIT"
repository = "https://github.com/chips/core"
description = "Chips生态的核心内核"

[lib]
name = "chips_core"
path = "src/lib.rs"

[[bin]]
name = "chips-core"
path = "src/main.rs"

[dependencies]
# 异步运行时
tokio = { version = "1.35", features = ["full"] }
async-trait = "0.1"
futures = "0.3"

# 序列化
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
serde_yaml = "0.9"
rmp-serde = "1.1"  # MessagePack

# 其他依赖...

[dev-dependencies]
criterion = { version = "0.5", features = ["html_reports"] }
mockall = "0.12"
tempfile = "3.8"

[[bench]]
name = "router_bench"
harness = false

[profile.release]
opt-level = 3
lto = true
codegen-units = 1
strip = true
panic = "abort"

[profile.dev]
opt-level = 0
debug = true

[features]
default = ["http-api", "cli"]
http-api = ["axum", "tower"]
cli = ["clap"]
webdav = ["reqwest/native-tls"]
python-runtime = ["pyo3"]
wasm-runtime = ["wasmtime"]
full = ["http-api", "cli", "webdav", "python-runtime", "wasm-runtime"]
```

### 7.2 .gitignore

```
# Rust
/target/
Cargo.lock
**/*.rs.bk
*.pdb

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Logs
*.log

# Test coverage
/coverage/
*.profdata
*.profraw
```

### 7.3 .github/workflows/test.yml

```yaml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, nightly]
    
    steps:
      - uses: actions/checkout@v3
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
      - name: Run tests
        run: cargo test --verbose
```

---

## 8. 模块依赖关系图

```
lib.rs (入口)
  │
  ├─> core (核心层)
  │    ├─> router (路由系统)
  │    │    ├─> event_bus
  │    │    ├─> route_table
  │    │    └─> utils/error
  │    │
  │    ├─> module (模块管理)
  │    │    ├─> registry
  │    │    ├─> loader
  │    │    ├─> dependency
  │    │    └─> utils/error
  │    │
  │    ├─> file (文件识别)
  │    │    ├─> detector
  │    │    ├─> card/parser
  │    │    └─> resource
  │    │
  │    └─> resource (资源管理)
  │         ├─> provider
  │         ├─> cache
  │         └─> utils/error
  │
  ├─> utils (工具)
  │    ├─> logger
  │    ├─> error
  │    ├─> id
  │    └─> crypto
  │
  └─> api (API层)
       ├─> sdk
       ├─> http
       ├─> cli
       └─> ipc
```

---

## 9. 文件大小估算

| 目录/文件 | 文件数 | 代码行数 | 说明 |
|-----------|--------|----------|------|
| `src/core/` | 2 | ~500 | 核心层 |
| `src/router/` | 6 | ~2000 | 路由系统 |
| `src/module/` | 8 | ~2500 | 模块管理 |
| `src/file/` | 8 | ~1500 | 文件识别 |
| `src/resource/` | 7 | ~1800 | 资源管理 |
| `src/utils/` | 5 | ~800 | 工具模块 |
| `src/api/` | 5 | ~1200 | API层 |
| **总计** | **41** | **~10300** | |

---

## 10. 编译输出结构 (target/)

```
target/
├── debug/                      # 调试版本
│   ├── chips-core             # 可执行文件
│   ├── chips-core.d           # 依赖信息
│   ├── libchips_core.rlib     # 库文件
│   ├── deps/                  # 依赖库
│   └── incremental/           # 增量编译
│
├── release/                    # 发布版本
│   ├── chips-core             # 优化的可执行文件
│   └── libchips_core.rlib     # 优化的库文件
│
└── doc/                        # 文档
    └── chips_core/
        └── index.html         # API文档入口
```

---

完整的文件结构索引为开发者提供了清晰的项目组织结构,每个目录和文件的作用都有详细说明,便于理解和导航代码库。
